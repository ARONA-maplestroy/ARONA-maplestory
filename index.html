<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ æ–°æ¥“ä¹‹è°· - è§’è‰²æŸ¥è©¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        /* æ¨™é¡Œå€åŸŸ */
        .header {
            text-align: center;
            padding: 40px 0;
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(90deg, #ff9a56, #ffcd56, #56c5ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: #888;
            font-size: 1.1em;
        }

        /* æœå°‹å€åŸŸ */
        .search-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-form {
            display: flex;
            gap: 15px;
        }

        .search-input {
            flex: 1;
            padding: 15px 25px;
            font-size: 1.2em;
            border: none;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            outline: none;
            transition: all 0.3s;
        }

        .search-input:focus {
            box-shadow: 0 0 20px rgba(255, 154, 86, 0.5);
        }

        .search-input::placeholder {
            color: #999;
        }

        .search-btn {
            padding: 15px 40px;
            font-size: 1.2em;
            border: none;
            border-radius: 50px;
            background: linear-gradient(90deg, #ff9a56, #ff6b6b);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .search-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.5);
        }

        .search-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* è¼‰å…¥åŠ¨ç”» */
        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #ff9a56;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* éŒ¯èª¤è¨Šæ¯ */
        .error {
            display: none;
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .error.show {
            display: block;
        }

        /* çµæœå€åŸŸ */
        .result {
            display: none;
        }

        .result.show {
            display: block;
        }

        /* è§’è‰²å¡ç‰‡ */
        .character-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            padding: 30px;
            background: linear-gradient(135deg, rgba(255, 154, 86, 0.3), rgba(255, 107, 107, 0.3));
        }

        .character-image {
            width: 120px;
            height: 120px;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.3);
            margin-right: 25px;
            object-fit: contain;
            padding: 10px;
        }

        .character-info h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .character-info .meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .meta-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .meta-item .server-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: #fff;
        }

        .meta-item .guild-icon {
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .meta-item.level {
            background: linear-gradient(90deg, #ff9a56, #ff6b6b);
            font-weight: bold;
        }

        /* ç¶“é©—é€²åº¦æ¢ */
        .exp-bar-container {
            margin: 15px 25px 0;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .exp-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            margin-bottom: 6px;
            color: #aaa;
        }

        .exp-bar-label span:last-child {
            color: #ffcd56;
            font-weight: bold;
        }

        .exp-bar-bg {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .exp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffcd56, #ff9a56);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* é è¨­é¸æ“‡å™¨ */
        .preset-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .preset-label {
            color: #888;
            font-size: 0.9em;
        }

        .preset-btn {
            padding: 6px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #aaa;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .preset-btn.active {
            background: linear-gradient(90deg, #56c5ff, #667eea);
            border-color: transparent;
            color: #fff;
            font-weight: bold;
        }

        .preset-note {
            color: #666;
            font-size: 0.8em;
            margin-left: auto;
        }

        /* å±¬æ€§å€åŸŸ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 25px;
        }

        .stat-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
        }

        .stat-section h3 {
            font-size: 1.1em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-name {
            color: #aaa;
        }

        .stat-value {
            font-weight: bold;
            color: #ffcd56;
        }

        .stat-value.highlight {
            color: #ff9a56;
            font-size: 1.1em;
        }

        /* é¸é …å¡ */
        .tabs {
            display: flex;
            gap: 10px;
            padding: 20px 25px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1em;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active {
            color: #ff9a56;
            border-bottom-color: #ff9a56;
        }

        /* ç¬¦æ–‡å’ŒæŠ€èƒ½ç¶²æ ¼ */
        .symbol-grid, .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }
        .symbol-item, .skill-item {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        .symbol-item:hover, .skill-item:hover {
            border-color: rgba(255,154,86,0.5);
            transform: translateY(-2px);
        }
        .symbol-name, .skill-name {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .symbol-level, .skill-level {
            color: #ffcd56;
            font-size: 1.3em;
            font-weight: bold;
        }
        .skill-desc {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }
        .tab-content { display: none; padding: 20px 25px; }
        .tab-content.active { display: block; }

        /* è£å‚™åˆ—è¡¨ */
        .equip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 15px;
        }
        .equip-item {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            gap: 12px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s;
        }
        .equip-item:hover {
            border-color: rgba(255,154,86,0.5);
            transform: translateY(-2px);
        }
        .equip-icon {
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            flex-shrink: 0;
        }
        .equip-info { flex: 1; min-width: 0; }
        .equip-name {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .equip-slot { font-size: 0.8em; color: #888; margin-bottom: 5px; }
        .equip-stats { font-size: 0.85em; color: #aaa; margin-bottom: 8px; }
        
        /* æ–°è£å‚™å¡ç‰‡è¨­è¨ˆ */
        .equip-item-new {
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        .equip-item-new:hover {
            border-color: rgba(255,154,86,0.5);
            transform: translateY(-2px);
        }
        .equip-header {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .equip-icon-large {
            width: 60px;
            height: 60px;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 5px;
            flex-shrink: 0;
        }
        .equip-title { flex: 1; }
        .equip-name-new {
            font-weight: bold;
            font-size: 1.1em;
            color: #fff;
            margin-bottom: 4px;
        }
        .equip-slot-new {
            font-size: 0.85em;
            color: #888;
        }
        .equip-starforce {
            color: #ffd700;
            font-size: 0.9em;
            margin-top: 4px;
        }
        .equip-grades {
            margin-bottom: 10px;
        }
        .grade-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            margin: 3px 0;
        }
        .grade-label {
            color: #888;
            min-width: 35px;
        }
        .equip-stat-details {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .equip-stat-row {
            font-size: 0.85em;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .equip-stat-row:last-child { border-bottom: none; }
        
        .equip-pot-section { margin-top: 8px; }
        .equip-pot-title { font-size: 0.8em; font-weight: bold; margin-bottom: 4px; padding: 2px 6px; border-radius: 4px; display: inline-block; }
        .equip-pot-title.legendary { background: #2ecc71; color: #fff; }
        .equip-pot-title.unique { background: #3498db; color: #fff; }
        .equip-pot-title.epic { background: #f1c40f; color: #333; }
        .equip-pot-title.rare { background: #9b59b6; color: #fff; }
        .equip-pot-line { font-size: 0.85em; padding: 4px 8px; margin: 2px 0; border-radius: 4px; border-left: 3px solid #666; background: rgba(0,0,0,0.2); }
        .equip-pot-line.legendary { border-left-color: #2ecc71; background: rgba(46, 204, 113, 0.15); color: #8aff8a; }
        .equip-pot-line.unique { border-left-color: #3498db; background: rgba(52, 152, 219, 0.15); color: #66ccff; }
        .equip-pot-line.epic { border-left-color: #f1c40f; background: rgba(241, 196, 15, 0.15); color: #ffcc00; }
        .equip-pot-line.rare { border-left-color: #9b59b6; background: rgba(155, 89, 182, 0.15); color: #cc88ff; }
        
        .equip-item { min-height: 120px; }
        .equip-item.equip-special { border: 1px solid rgba(255, 193, 7, 0.3); background: rgba(255, 193, 7, 0.05); }
        .equip-item-new.equip-special-new { border: 1px solid rgba(255, 193, 7, 0.3); background: rgba(255, 193, 7, 0.08); }
        .equip-desc { font-size: 0.8em; color: #aaa; margin-top: 4px; }
        
        /* è£å‚™é è¨­é¸æ“‡å™¨ */
        .equip-preset-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            margin-bottom: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .star-force { color: #ffdd44; font-size: 0.85em; }
        .no-equip { text-align: center; padding: 40px; color: #666; }

        /* æˆ°é¬¥åŠ›å€åŸŸ */
        .combat-power-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 25px;
            background: linear-gradient(135deg, rgba(255, 154, 86, 0.2), rgba(255, 205, 86, 0.2));
            border-radius: 15px;
            margin: 0 25px 25px;
            gap: 20px;
        }

        .combat-power-main {
            flex: 1;
        }

        .combat-power-label {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 5px;
        }

        .combat-power-value {
            font-size: 2.2em;
            font-weight: bold;
            background: linear-gradient(90deg, #ff9a56, #ffcd56);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .combat-power-history {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            min-width: 180px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .history-label {
            font-size: 0.8em;
            color: #888;
        }

        .history-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #43e97b;
        }

        .history-date {
            font-size: 0.85em;
            color: #56c5ff;
        }

        /* è¯ç›Ÿæ¨£å¼ */
        .union-loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }

        .union-level-box {
            text-align: center;
            padding: 20px;
        }

        .union-level-number {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(90deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .union-grade {
            font-size: 1.2em;
            color: #ffd700;
            margin-top: 10px;
        }

        .union-artifact-level {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .union-artifact-effects {
            margin-top: 15px;
        }

        .artifact-effect-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .artifact-effect-name {
            color: #ddd;
        }

        .artifact-effect-level {
            color: #ffd700;
            font-weight: bold;
        }

        .champion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .champion-card {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
        }

        .champion-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .champion-avatar-wrapper {
            flex-shrink: 0;
        }

        .champion-avatar {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: rgba(0,0,0,0.3);
            object-fit: contain;
        }

        .champion-avatar-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .champion-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .champion-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #fff;
        }

        .champion-grade {
            padding: 3px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85em;
            flex-shrink: 0;
        }

        .champion-grade.SSS { background: linear-gradient(90deg, #ffd700, #ffaa00); color: #333; }
        .champion-grade.SS { background: linear-gradient(90deg, #c0c0c0, #a0a0a0); color: #333; }
        .champion-grade.S { background: linear-gradient(90deg, #cd7f32, #b87333); color: #fff; }

        .champion-class {
            color: #aaa;
            font-size: 0.9em;
        }

        .champion-badges {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .champion-badge {
            font-size: 0.85em;
            color: #ccc;
            padding: 5px 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }

        .champion-total {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,165,0,0.1));
            border-radius: 12px;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .champion-total h4 {
            color: #ffd700;
            margin-bottom: 10px;
        }

        .union-raider-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }

        .raider-stat-item {
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            font-size: 0.9em;
            color: #ccc;
        }

        .union-occupied-stats {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .union-occupied-stats h4 {
            color: #56c5ff;
            margin-bottom: 10px;
        }

        /* è¯ç›Ÿæ‹¼å›¾æ ·å¼ */
        .union-puzzle-container {
            overflow-x: auto;
            padding: 10px;
        }

        .union-puzzle {
            display: grid;
            grid-template-columns: repeat(22, 18px);
            grid-template-rows: repeat(20, 18px);
            gap: 1px;
            background: rgba(0,0,0,0.3);
            padding: 5px;
            border-radius: 8px;
            width: fit-content;
            margin: 0 auto;
        }

        .puzzle-cell {
            width: 18px;
            height: 18px;
            background: rgba(255,255,255,0.05);
            border-radius: 2px;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.3);
        }

        .puzzle-cell.occupied {
            background: rgba(102, 126, 234, 0.6);
            border: 1px solid rgba(102, 126, 234, 0.8);
        }

        .puzzle-cell.warrior { background: rgba(220, 53, 69, 0.6); border-color: rgba(220, 53, 69, 0.8); }
        .puzzle-cell.mage { background: rgba(0, 123, 255, 0.6); border-color: rgba(0, 123, 255, 0.8); }
        .puzzle-cell.archer { background: rgba(40, 167, 69, 0.6); border-color: rgba(40, 167, 69, 0.8); }
        .puzzle-cell.thief { background: rgba(111, 66, 193, 0.6); border-color: rgba(111, 66, 193, 0.8); }
        .puzzle-cell.pirate { background: rgba(253, 126, 20, 0.6); border-color: rgba(253, 126, 20, 0.8); }
        .puzzle-cell.hybrid { background: rgba(255, 193, 7, 0.6); border-color: rgba(255, 193, 7, 0.8); }
        .puzzle-cell.xenon { background: rgba(23, 162, 184, 0.6); border-color: rgba(23, 162, 184, 0.8); }

        .puzzle-cell.center-zone {
            background: rgba(255,255,255,0.15);
        }

        .puzzle-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85em;
            color: #aaa;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        /* å†…åœ¨èƒ½åŠ›æ ·å¼ */
        .ability-preset-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .ability-preset-btn {
            padding: 8px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #aaa;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .ability-preset-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .ability-preset-btn.active {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
            border-color: transparent;
            color: #fff;
            font-weight: bold;
        }

        .ability-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ability-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border-left: 4px solid #666;
        }

        .ability-item.legendary {
            border-left-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }

        .ability-item.unique {
            border-left-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .ability-item.epic {
            border-left-color: #f1c40f;
            background: rgba(241, 196, 15, 0.1);
        }

        .ability-item.rare {
            border-left-color: #9b59b6;
            background: rgba(155, 89, 182, 0.1);
        }

        .ability-grade {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }

        .ability-grade.legendary { background: #2ecc71; color: #fff; }
        .ability-grade.unique { background: #3498db; color: #fff; }
        .ability-grade.epic { background: #f1c40f; color: #333; }
        .ability-grade.rare { background: #9b59b6; color: #fff; }

        .ability-value {
            flex: 1;
            color: #fff;
            font-size: 0.95em;
        }

        .ability-loading, .ability-empty {
            text-align: center;
            padding: 20px;
            color: #888;
        }

        /* é¡µè„š */
        .footer {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 0.9em;
        }

        .footer a {
            color: #ff9a56;
            text-decoration: none;
        }

        /* å¯¼èˆªåˆ‡æ¢ */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #aaa;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .nav-tab.active {
            background: linear-gradient(90deg, #ff9a56, #ff6b6b);
            border-color: transparent;
            color: #fff;
            font-weight: bold;
        }

        /* æ’è¡Œæ¦œå€åŸŸ */
        .ranking-section {
            display: none;
        }

        .ranking-section.show {
            display: block;
        }

        .ranking-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ranking-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 0.85em;
            color: #888;
        }

        .filter-select {
            padding: 10px 15px;
            font-size: 1em;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            cursor: pointer;
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #ff9a56;
        }

        .filter-select option {
            background: #1a1a2e;
            color: #fff;
        }

        .ranking-search-btn {
            padding: 10px 25px;
            background: linear-gradient(90deg, #56c5ff, #667eea);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .ranking-search-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .ranking-search-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* æ’è¡Œæ¦œåˆ—è¡¨ */
        .ranking-list {
            margin-top: 20px;
        }

        .ranking-header {
            display: grid;
            grid-template-columns: 60px 80px 1fr 150px 150px 180px;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px 10px 0 0;
            font-weight: bold;
            color: #aaa;
            font-size: 0.9em;
        }

        .ranking-item {
            display: grid;
            grid-template-columns: 60px 80px 1fr 150px 150px 180px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .ranking-item:hover {
            background: rgba(255, 154, 86, 0.1);
        }

        .ranking-item:last-child {
            border-radius: 0 0 10px 10px;
        }

        .rank-number {
            font-weight: bold;
            font-size: 1.2em;
        }

        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        .rank-avatar {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            object-fit: contain;
        }

        .rank-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .rank-class {
            color: #aaa;
            font-size: 0.9em;
        }

        .rank-server {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rank-power {
            font-weight: bold;
            font-size: 1.1em;
            background: linear-gradient(90deg, #ff9a56, #ffcd56);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .ranking-pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .page-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            padding: 8px 16px;
            color: #888;
        }

        .ranking-loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .ranking-empty {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* å›æ‡‰å¼æ’è¡Œæ¦œ */
        @media (max-width: 900px) {
            .ranking-header, .ranking-item {
                grid-template-columns: 50px 60px 1fr 100px 130px;
            }
            .ranking-header > *:nth-child(4),
            .ranking-item > *:nth-child(4) {
                display: none;
            }
        }

        @media (max-width: 600px) {
            .ranking-header, .ranking-item {
                grid-template-columns: 40px 50px 1fr 100px;
            }
            .ranking-header > *:nth-child(4),
            .ranking-item > *:nth-child(4),
            .ranking-header > *:nth-child(5),
            .ranking-item > *:nth-child(5) {
                display: none;
            }
            .ranking-filters {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-select {
                width: 100%;
            }
        }

        /* å›æ‡‰å¼ */
        @media (max-width: 600px) {
            .search-form {
                flex-direction: column;
            }

            .card-header {
                flex-direction: column;
                text-align: center;
            }

            .character-image {
                margin-right: 0;
                margin-bottom: 20px;
            }

            .character-info .meta {
                justify-content: center;
            }

            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
    <script>
    // è·æ¥­è³‡æ–™ - ä½¿ç”¨decodeURIComponentè§£ç é¿å…ç¼–ç é—®é¢˜
    const TW_CLASS_DATA = JSON.parse(decodeURIComponent('%5B%5B%22%E5%86%92%E9%9A%AA%E5%AE%B6-%E6%88%B0%E5%A3%AB%22%2C%5B%22%E8%81%96%E9%A8%8E%E5%A3%AB%22%2C%22%E9%BB%91%E9%A8%8E%E5%A3%AB%22%2C%22%E8%8B%B1%E9%9B%84%22%5D%5D%2C%5B%22%E5%86%92%E9%9A%AA%E5%AE%B6-%E6%B3%95%E5%B8%AB%22%2C%5B%22%E7%81%AB%E6%AF%92%E9%AD%94%E5%B0%8E%E5%A3%AB%22%2C%22%E5%86%B0%E9%9B%B7%E9%AD%94%E5%B0%8E%E5%A3%AB%22%2C%22%E4%B8%BB%E6%95%99%22%5D%5D%2C%5B%22%E5%86%92%E9%9A%AA%E5%AE%B6-%E5%BC%93%E7%AE%AD%E6%89%8B%22%2C%5B%22%E7%AE%AD%E7%A5%9E%22%2C%22%E7%A5%9E%E5%B0%84%E6%89%8B%22%2C%22%E5%8F%A4%E4%BB%A3%E7%A5%9E%E5%B0%84%E6%89%8B%22%5D%5D%2C%5B%22%E5%86%92%E9%9A%AA%E5%AE%B6-%E7%9B%9C%E8%B3%8A%22%2C%5B%22%E5%A4%9C%E4%BD%BF%E8%80%85%22%2C%22%E6%9A%97%E5%BD%B1%E7%A5%9E%E5%81%B7%22%2C%22%E5%BD%B1%E6%AD%A6%E8%80%85%22%5D%5D%2C%5B%22%E5%86%92%E9%9A%AA%E5%AE%B6-%E6%B5%B7%E7%9B%9C%22%2C%5B%22%E6%8B%B3%E9%9C%B8%22%2C%22%E6%A7%8D%E7%A5%9E%22%2C%22%E8%88%B9%E9%95%B7%22%5D%5D%2C%5B%22%E7%9A%87%E5%AE%B6%E9%A8%8E%E5%A3%AB%E5%9C%98%22%2C%5B%22%E9%AD%82%E9%A8%8E%E5%A3%AB%22%2C%22%E7%83%88%E7%84%B0%E5%B7%AB%E5%B8%AB%22%2C%22%E7%8B%82%E9%A2%A8%E7%A5%9E%E5%B0%84%22%2C%22%E6%9A%97%E5%BD%B1%E9%9B%99%E5%88%80%22%2C%22%E9%96%83%E9%9B%B7%E6%82%8D%E5%B0%87%22%5D%5D%2C%5B%22%E8%8B%B1%E9%9B%84%22%2C%5B%22%E7%8B%82%E7%8B%BC%E5%8B%87%E5%A3%AB%22%2C%22%E9%BE%8D%E9%AD%94%E5%B0%8E%E5%A3%AB%22%2C%22%E7%B2%BE%E9%9D%88%E9%81%8A%E4%BF%A0%22%2C%22%E5%B9%BB%E5%BD%B1%E4%BF%A0%E7%9B%9C%22%2C%22%E9%9A%B1%E6%9C%88%22%2C%22%E9%9B%99%E5%BC%A9%E7%B2%BE%E9%9D%88%22%5D%5D%2C%5B%22%E5%8F%8D%E6%8A%97%E8%BB%8D%22%2C%5B%22%E7%88%86%E7%A0%B4%E6%89%8B%22%2C%22%E6%A9%9F%E7%94%B2%E6%88%B0%E7%A5%9E%22%2C%22%E8%B1%B9%E5%BC%A9%E9%81%8A%E4%BF%A0%22%2C%22%E9%87%8D%E7%A0%B2%E6%8C%87%E6%8F%AE%E5%AE%98%22%2C%22%E6%83%A1%E9%AD%94%E6%AE%BA%E6%89%8B%22%2C%22%E6%83%A1%E9%AD%94%E5%BE%A9%E4%BB%87%E8%80%85%22%5D%5D%2C%5B%22%E8%B6%85%E6%96%B0%E6%98%9F%22%2C%5B%22%E5%87%B1%E8%96%A9%22%2C%22%E5%A4%A9%E4%BD%BF%E7%A0%B4%E5%A3%9E%E8%80%85%22%2C%22%E5%8D%A1%E8%92%82%E5%A8%9C%22%5D%5D%2C%5B%22%E6%9B%89%E4%B9%8B%E9%99%A3%22%2C%5B%22%E7%B1%B3%E5%93%88%E9%80%B8%22%5D%5D%2C%5B%22%E7%A5%9E%E4%B9%8B%E5%AD%90%22%2C%5B%22%E7%A5%9E%E4%B9%8B%E5%AD%90%22%5D%5D%2C%5B%22%E8%B6%85%E8%83%BD%E5%8A%9B%E8%80%85%22%2C%5B%22%E5%87%B1%E5%85%A7%E8%A5%BF%E6%96%AF%22%5D%5D%2C%5B%22%E5%85%B6%E4%BB%96%22%2C%5B%22%E5%8A%8D%E8%B1%AA%22%2C%22%E9%99%B0%E9%99%BD%E5%B8%AB%22%2C%22%E5%A2%A8%E7%8E%84%22%2C%22%E7%90%B3%E6%81%A9%22%5D%5D%2C%5B%22%E9%98%BF%E5%B0%BC%E7%91%AA%22%2C%5B%22%E8%99%8E%E5%BD%B1%22%2C%22%E8%8F%88%E8%8F%88%22%2C%22%E8%93%AE%22%2C%22%E4%BA%9E%E5%85%8B%22%5D%5D%2C%5B%22%E8%AB%BE%E5%B7%B4%22%2C%5B%22%E9%98%BF%E6%88%B4%E7%88%BE%22%2C%22%E4%BC%8A%E5%88%A9%E6%81%A9%22%5D%5D%5D'));
    </script>
</head>
<body>
    <div class="container">
        <!-- æ ‡é¢˜ -->
        <div class="header">
            <h1>ğŸ æ–°æ¥“ä¹‹è°·</h1>
            <p>è§’è‰²è³‡è¨ŠæŸ¥è¯¢å·¥å…·</p>
        </div>

        <!-- å¯¼èˆªåˆ‡æ¢ - æ’è¡Œæ¦œåŠŸèƒ½æš‚æ—¶éšè—ï¼ˆå°æœAPIæœªå¼€æ”¾ï¼‰ -->
        <!--
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchMainTab('search')">ğŸ” è§’è‰²æŸ¥è©¢</button>
            <button class="nav-tab" onclick="switchMainTab('ranking')">ğŸ† æˆ°é¬¥åŠ›æ’è¡Œ</button>
        </div>
        -->

        <!-- è§’è‰²æŸ¥è©¢å€åŸŸ -->
        <div id="search-section">
        <!-- æœå°‹æ¡† -->
        <div class="search-box">
            <form class="search-form" onsubmit="searchCharacter(event)">
                <input type="text" id="characterName" class="search-input" 
                       placeholder="è¼¸å…¥è§’è‰²åç§°ï¼ˆç¹ä½“ä¸­æ–‡ï¼‰" autocomplete="off">
                <button type="submit" class="search-btn" id="searchBtn">ğŸ” æŸ¥è¯¢</button>
            </form>
        </div>

        <!-- è¼‰å…¥åŠ¨ç”» -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨æŸ¥è¯¢è§’è‰²è³‡è¨Š...</p>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div class="error" id="error">
            <p id="errorMsg">æŸ¥è¯¢å¤±è´¥</p>
        </div>

        <!-- æŸ¥è¯¢ç»“æœ -->
        <div class="result" id="result">
            <div class="character-card">
                <div class="card-header">
                    <img id="charImage" class="character-image" src="" alt="è§’è‰²å½¢è±¡">
                    <div class="character-info">
                        <h2 id="charName">è§’è‰²åç§°</h2>
                        <div class="meta">
                            <span class="meta-item level" id="charLevel">Lv.000</span>
                            <span class="meta-item" id="charClass">è·æ¥­</span>
                            <span class="meta-item" id="charWorld"><span class="server-icon" id="serverIcon">ğŸŒ</span><span id="serverName">ä¸–ç•Œ</span></span>
                            <span class="meta-item" id="charGuild"><span class="guild-icon">âš”</span><span id="guildName">å…¬ä¼š</span></span>
                        </div>
                    </div>
                </div>

                <!-- ç¶“é©—é€²åº¦æ¢ -->
                <div class="exp-bar-container">
                    <div class="exp-bar-label">
                        <span>EXP</span>
                        <span id="expPercent">0%</span>
                    </div>
                    <div class="exp-bar-bg">
                        <div class="exp-bar-fill" id="expBarFill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- é¸é …å¡ -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('stats')">ğŸ“Š å±æ€§</button>
                    <button class="tab-btn" onclick="switchTab('equip')">âš”ï¸ è£å‚™</button>
                    <button class="tab-btn" onclick="switchTab('symbol')">ğŸ”® ç¬¦æ–‡</button>
                    <button class="tab-btn" onclick="switchTab('skill')">âœ¨ æŠ€èƒ½</button>
                    <button class="tab-btn" onclick="switchTab('union')">ğŸ° è¯ç›Ÿ</button>
                </div>

                <!-- å±æ€§é¡µ -->
                <div class="tab-content active" id="tab-stats">
                    <!-- æˆ°é¬¥åŠ› -->
                    <div class="combat-power-section">
                        <div class="combat-power-main">
                            <div class="combat-power-label">âš”ï¸ ç•¶å‰æˆ°é¬¥åŠ›</div>
                            <div class="combat-power-value" id="combatPower">0</div>
                        </div>
                        <div class="combat-power-history">
                            <div class="history-item">
                                <span class="history-label">ğŸ“ˆ 5æ—¥æœ€é«˜</span>
                                <span class="history-value" id="maxCombatPower">-</span>
                            </div>
                            <div class="history-item">
                                <span class="history-label">ğŸ“… æ—¥æœŸ</span>
                                <span class="history-date" id="maxCombatPowerDate">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- å±æ€§ç¶²æ ¼ -->
                    <div class="stats-grid">
                    <!-- æˆ˜æ–—å±æ€§ -->
                    <div class="stat-section">
                        <h3>âš”ï¸ æˆ˜æ–—å±æ€§</h3>
                        <div class="stat-row">
                            <span class="stat-name">å±æ€§æ”»å‡»</span>
                            <span class="stat-value" id="statAttack">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">æ”»å‡»åŠ›</span>
                            <span class="stat-value" id="statAtt">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">æ˜ŸåŠ›</span>
                            <span class="stat-value" id="statStar">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">ç¥ç§˜åŠ›é‡</span>
                            <span class="stat-value" id="statArcane">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">çœŸå®ä¹‹åŠ›</span>
                            <span class="stat-value" id="statAuthentic">0</span>
                        </div>
                    </div>

                    <!-- ä¼¤å®³å±æ€§ -->
                    <div class="stat-section">
                        <h3>ğŸ’¥ ä¼¤å®³å±æ€§</h3>
                        <div class="stat-row">
                            <span class="stat-name">ä¼¤å®³</span>
                            <span class="stat-value" id="statDmg">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">BOSSä¼¤å®³</span>
                            <span class="stat-value highlight" id="statBoss">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">æœ€ç»ˆä¼¤å®³</span>
                            <span class="stat-value" id="statFinal">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">æ— è§†é˜²å¾¡</span>
                            <span class="stat-value highlight" id="statIED">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">çˆ†å‡»ç‡ / çˆ†ä¼¤</span>
                            <span class="stat-value" id="statCrit">0% / 0%</span>
                        </div>
                    </div>

                    <!-- åŸºæœ¬å±æ€§ -->
                    <div class="stat-section">
                        <h3>ğŸ’ª åŸºæœ¬å±æ€§</h3>
                        <div class="stat-row">
                            <span class="stat-name">STR</span>
                            <span class="stat-value" id="statSTR">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">DEX</span>
                            <span class="stat-value" id="statDEX">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">INT</span>
                            <span class="stat-value" id="statINT">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">LUK</span>
                            <span class="stat-value" id="statLUK">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">HP / MP</span>
                            <span class="stat-value" id="statHPMP">0 / 0</span>
                        </div>
                    </div>

                    <!-- é¢å¤–å±æ€§ -->
                    <div class="stat-section">
                        <h3>ğŸ é¢å¤–å±æ€§</h3>
                        <div class="stat-row">
                            <span class="stat-name">é“å…·æ‰è½ç‡</span>
                            <span class="stat-value" id="statDrop">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">æ«å¸è·å¾—é‡</span>
                            <span class="stat-value" id="statMeso">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">é¢å¤–ç¶“é©—å€¼</span>
                            <span class="stat-value" id="statExp">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">BuffæŒç»­</span>
                            <span class="stat-value" id="statBuff">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">å†·å´å‡å°‘</span>
                            <span class="stat-value" id="statCD">0s / 0%</span>
                        </div>
                    </div>

                    <!-- å†…åœ¨èƒ½åŠ› -->
                    <div class="stat-section" style="grid-column: 1/-1;">
                        <h3>ğŸŒŸ å†…åœ¨èƒ½åŠ›</h3>
                        <div class="ability-preset-selector">
                            <button class="ability-preset-btn active" onclick="changeAbilityPreset(1)">ç¬¬ 1 é¡µ</button>
                            <button class="ability-preset-btn" onclick="changeAbilityPreset(2)">ç¬¬ 2 é¡µ</button>
                            <button class="ability-preset-btn" onclick="changeAbilityPreset(3)">ç¬¬ 3 é¡µ</button>
                        </div>
                        <div class="ability-list" id="abilityList">
                            <div class="ability-loading">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è£å‚™é¡µ -->
        <div class="tab-content" id="tab-equip">
            <!-- è£å‚™é è¨­é¸æ“‡å™¨ -->
            <div class="equip-preset-selector">
                <span class="preset-label">è£å‚™é è¨­:</span>
                <button class="preset-btn active" onclick="changePreset(1)">é è¨­ 1</button>
                <button class="preset-btn" onclick="changePreset(2)">é è¨­ 2</button>
                <button class="preset-btn" onclick="changePreset(3)">é è¨­ 3</button>
            </div>
            <div class="stats-grid">
                <div class="stat-section" style="grid-column: 1/-1;">
                    <h3>âš”ï¸ è£å‚™è©³æƒ…</h3>
                    <div class="equip-grid" id="equipGrid" data-loaded="false">
                        <div class="no-equip">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¬¦æ–‡é¡µ -->
        <div class="tab-content" id="tab-symbol">
            <div class="stats-grid">
                <div class="stat-section" style="grid-column: 1/-1;">
                    <h3>ğŸ”® ç¬¦æ–‡ç³»ç»Ÿ</h3>
                    <div class="symbol-grid" id="symbolGrid" data-loaded="false">
                        <div class="no-equip">ğŸ‘† ç‚¹å‡»"ç¬¦æ–‡"é¸é …å¡è¼‰å…¥è³‡æ–™</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æŠ€èƒ½é¡µ -->
        <div class="tab-content" id="tab-skill">
            <div class="stats-grid">
                <div class="stat-section" style="grid-column: 1/-1;">
                    <h3>âœ¨ VçŸ©é™£ & HEXA</h3>
                    <div class="skill-grid" id="skillGrid" data-loaded="false">
                        <div class="no-equip">ğŸ‘† ç‚¹å‡»"æŠ€èƒ½"é¸é …å¡è¼‰å…¥è³‡æ–™</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯ç›Ÿé¡µ -->
        <div class="tab-content" id="tab-union">
            <div class="stats-grid">
                <!-- è¯ç›Ÿç­‰çº§ -->
                <div class="stat-section">
                    <h3>ğŸ° è¯ç›Ÿç­‰çº§</h3>
                    <div class="union-level-info" id="unionLevelInfo">
                        <div class="union-loading">ğŸ‘† ç‚¹å‡»"è¯ç›Ÿ"é¸é …å¡è¼‰å…¥è³‡æ–™</div>
                    </div>
                </div>

                <!-- è¯ç›Ÿç¥å™¨ -->
                <div class="stat-section">
                    <h3>ğŸ”± è¯ç›Ÿç¥å™¨</h3>
                    <div class="union-artifact-info" id="unionArtifactInfo">
                        <div class="union-loading">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>

                <!-- å† å†›è¯ç›Ÿ -->
                <div class="stat-section" style="grid-column: 1/-1;">
                    <h3>ğŸ‘‘ å† å†›è¯ç›Ÿ</h3>
                    <div class="union-champion-info" id="unionChampionInfo">
                        <div class="union-loading">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>

                <!-- è¯ç›Ÿæ”»å‡»é˜Ÿ -->
                <div class="stat-section" style="grid-column: 1/-1;">
                    <h3>âš”ï¸ è¯ç›Ÿæ”»å‡»é˜Ÿæ•ˆæœ</h3>
                    <div class="union-raider-info" id="unionRaiderInfo">
                        <div class="union-loading">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>

                <!-- è¯ç›Ÿæ‹¼å›¾ -->
                <div class="stat-section" style="grid-column: 1/-1;">
                    <h3>ğŸ§© è¯ç›Ÿå é¢†å€åŸŸ</h3>
                    <div class="union-puzzle-container" id="unionPuzzleContainer">
                        <div class="union-loading">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
        </div>
        <!-- è§’è‰²æŸ¥è©¢å€åŸŸç»“æŸ -->

        <!-- æ’è¡Œæ¦œå€åŸŸ - æš‚æ—¶éšè—ï¼ˆå°æœAPIæœªå¼€æ”¾æ’è¡Œæ¦œåŠŸèƒ½ï¼‰ -->
        <!--
        <div id="ranking-section" class="ranking-section">
            <div class="ranking-box">
                <h2 style="margin-bottom: 20px; color: #ffcd56;">ğŸ† æˆ°é¬¥åŠ›æ’è¡Œæ¦œ</h2>
                <div class="ranking-filters">
                    <div class="filter-group">
                        <span class="filter-label">ğŸŒ ä¼ºæœå™¨</span>
                        <select id="rankingWorld" class="filter-select">
                            <option value="">å…¨éƒ¨ä¼ºæœå™¨</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">âš”ï¸ è·æ¥­</span>
                        <select id="rankingClass" class="filter-select">
                            <option value="">å…¨éƒ¨è·æ¥­</option>
                        </select>
                    </div>
                    <div class="filter-group" style="margin-left: auto;">
                        <span class="filter-label">&nbsp;</span>
                        <button class="ranking-search-btn" onclick="loadRanking(1)">ğŸ” æŸ¥è¯¢æ’è¡Œ</button>
                    </div>
                </div>
                <div class="ranking-list" id="rankingList">
                    <div class="ranking-empty">ğŸ‘† é¸æ“‡ç­›é€‰æ¢ä»¶åç‚¹å‡»æŸ¥è¯¢</div>
                </div>
                <div class="ranking-pagination" id="rankingPagination" style="display: none;">
                    <button class="page-btn" id="prevPageBtn" onclick="loadRanking(currentRankPage - 1)">â—€ ä¸Šä¸€é¡µ</button>
                    <span class="page-info" id="pageInfo">ç¬¬ 1 é¡µ</span>
                    <button class="page-btn" id="nextPageBtn" onclick="loadRanking(currentRankPage + 1)">ä¸‹ä¸€é¡µ â–¶</button>
                </div>
            </div>
        </div>
        -->

        <!-- é¡µè„š -->
        <div class="footer">
            <p>è³‡æ–™æ¥æºï¼š<a href="https://openapi.nexon.com" target="_blank">Nexon Open API</a></p>
            <p>Created with â¤ï¸ by memU bot</p>
        </div>
    </div>

    <script>
        // APIé…ç½®
        const API_KEY = 'test_5c0b00a395afdccd7c9c55d45415c5f660ccb22adf4a2a2aaac94083c194d3e6efe8d04e6d233bd35cf2fabdeb93fb0d';
        const BASE_URL = 'https://open.api.nexon.com/maplestorytw/v1';
        let currentOcid = null;
        let currentPreset = 1;
        let currentRankPage = 1;
        let rankingCache = {};

        // APIè«‹æ±‚é˜Ÿåˆ—æ§åˆ¶ï¼ˆé¿å…é™æµï¼‰
        let lastApiCallTime = 0;
        const API_CALL_INTERVAL = 300; // æ¯æ¬¡APIèª¿ç”¨é—´éš”300ms
        
        // APIè«‹æ±‚å‡½æ•°
        async function apiRequest(endpoint, params = {}) {
            // æ§åˆ¶è«‹æ±‚é¢‘ç‡ï¼Œé¿å…OPENAPI00007éŒ¯èª¤
            const now = Date.now();
            const timeSinceLastCall = now - lastApiCallTime;
            if (timeSinceLastCall < API_CALL_INTERVAL) {
                await new Promise(resolve => setTimeout(resolve, API_CALL_INTERVAL - timeSinceLastCall));
            }
            lastApiCallTime = Date.now();
            
            const queryString = Object.entries(params)
                .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
                .join('&');
            const url = `${BASE_URL}${endpoint}${queryString ? '?' + queryString : ''}`;

            const response = await fetch(url, {
                headers: { 'x-nxopen-api-key': API_KEY }
            });
            return response.json();
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            if (num >= 100000000) {
                return (num / 100000000).toFixed(2) + 'äº¿';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(1) + 'ä¸‡';
            }
            return num.toLocaleString();
        }

        // ç²å–å±æ€§å€¼
        function getStatValue(stats, name) {
            const stat = stats.find(s => s.stat_name === name);
            return stat ? stat.stat_value : '0';
        }

        // é¡¯ç¤º/éšè—å…ƒç´ 
        function showElement(id, show) {
            document.getElementById(id).classList.toggle('show', show);
        }

        // é¡¯ç¤ºéŒ¯èª¤
        function showError(msg) {
            document.getElementById('errorMsg').textContent = msg;
            showElement('error', true);
            showElement('loading', false);
            showElement('result', false);
        }

        // æœå°‹è§’è‰²
        async function searchCharacter(event) {
            event.preventDefault();

            const name = document.getElementById('characterName').value.trim();
            if (!name) {
                showError('è«‹è¼¸å…¥è§’è‰²åç§°');
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥
            showElement('loading', true);
            showElement('error', false);
            showElement('result', false);
            document.getElementById('searchBtn').disabled = true;

            try {
                // 1. ç²å–OCID
                const idResult = await apiRequest('/id', { character_name: name });
                
                if (idResult.error) {
                    if (idResult.error.name === 'OPENAPI00005') {
                        showError('âŒ API Keyå·²è¿‡æœŸï¼Œè«‹è”ç³»ç®¡ç†å‘˜æ›´æ–°');
                    } else if (idResult.error.name === 'OPENAPI00004') {
                        showError('âŒ æ‰¾ä¸åˆ°è¯¥è§’è‰²ï¼Œè«‹æ£€æŸ¥åç§°æ˜¯å¦æ­£ç¡®ï¼ˆéœ€ä½¿ç”¨ç¹ä½“ä¸­æ–‡ï¼‰');
                    } else {
                        showError('âŒ ' + idResult.error.message);
                    }
                    return;
                }

                const ocid = idResult.ocid;
                currentOcid = ocid;

                // 2. ç²å–åŸºæœ¬è³‡è¨Šå’Œå±æ€§
                const [basicResult, statResult] = await Promise.all([
                    apiRequest('/character/basic', { ocid }),
                    apiRequest('/character/stat', { ocid })
                ]);

                if (basicResult.error) {
                    showError('âŒ ç²å–è§’è‰²è³‡è¨Šå¤±è´¥: ' + basicResult.error.message);
                    return;
                }

                // 3. é¡¯ç¤ºç»“æœ
                displayResult(basicResult, statResult);
                
                // é‡ç½®æ‰€æœ‰æ‡’è¼‰å…¥è³‡æ–™
                document.getElementById('equipGrid').innerHTML = '<div class="no-equip">ğŸ‘† ç‚¹å‡»"è£å‚™"é¸é …å¡è¼‰å…¥è£å‚™è³‡æ–™</div>';
                document.getElementById('equipGrid').dataset.loaded = 'false';
                document.getElementById('symbolGrid').innerHTML = '<div class="no-equip">ğŸ‘† ç‚¹å‡»"ç¬¦æ–‡"é¸é …å¡è¼‰å…¥è³‡æ–™</div>';
                document.getElementById('symbolGrid').dataset.loaded = 'false';
                document.getElementById('skillGrid').innerHTML = '<div class="no-equip">ğŸ‘† ç‚¹å‡»"æŠ€èƒ½"é¸é …å¡è¼‰å…¥è³‡æ–™</div>';
                document.getElementById('skillGrid').dataset.loaded = 'false';
                currentOcid = ocid;
                
                // 4. è¼‰å…¥å†…åœ¨èƒ½åŠ›
                loadAbility(ocid);

            } catch (e) {
                showError('âŒ è«‹æ±‚å¤±æ•—: ' + e.message);
            } finally {
                document.getElementById('searchBtn').disabled = false;
                showElement('loading', false);
            }
        }

        // å°æœä¼ºæœå™¨é¢œè‰²æ˜ å°„
        const serverColors = {
            'è‰¾éº—äº': { bg: 'linear-gradient(135deg, #ff6b6b, #ff8e8e)', letter: 'A' },
            'æ™®åŠ›ç‰¹': { bg: 'linear-gradient(135deg, #4ecdc4, #44a08d)', letter: 'P' },
            'ç‰å¾·': { bg: 'linear-gradient(135deg, #667eea, #764ba2)', letter: 'L' },
            'å„ªä¼Šå¨œ': { bg: 'linear-gradient(135deg, #f093fb, #f5576c)', letter: 'U' },
            'æ„›éº—è¥¿äº': { bg: 'linear-gradient(135deg, #4facfe, #00f2fe)', letter: 'E' },
            'æ®ºäººé¯¨': { bg: 'linear-gradient(135deg, #43e97b, #38f9d7)', letter: 'O' },
            'æŒ‘æˆ°è€…': { bg: 'linear-gradient(135deg, #fa709a, #fee140)', letter: 'C' },
            'è³½è“®': { bg: 'linear-gradient(135deg, #a8edea, #fed6e3)', letter: 'S' },
            'ç±³ç‰¹æ‹‰': { bg: 'linear-gradient(135deg, #ffecd2, #fcb69f)', letter: 'M' },
            'ç‘æ™®': { bg: 'linear-gradient(135deg, #a18cd1, #fbc2eb)', letter: 'R' }
        };

        // é¡¯ç¤ºç»“æœ
        function displayResult(basic, stat) {
            // åŸºæœ¬è³‡è¨Š
            document.getElementById('charImage').src = basic.character_image || '';
            document.getElementById('charName').textContent = basic.character_name;
            document.getElementById('charLevel').textContent = 'Lv.' + basic.character_level;
            document.getElementById('charClass').textContent = basic.character_class;
            
            // ä¼ºæœå™¨ - ä½¿ç”¨è‡ªå®šä¹‰åœ–æ¨™
            const worldName = basic.world_name || 'æœªçŸ¥';
            const serverInfo = serverColors[worldName] || { bg: 'linear-gradient(135deg, #6c757d, #495057)', letter: worldName.charAt(0) };
            const serverIcon = document.getElementById('serverIcon');
            serverIcon.style.background = serverInfo.bg;
            serverIcon.textContent = serverInfo.letter;
            document.getElementById('serverName').textContent = worldName;
            
            // å…¬ä¼š
            document.getElementById('guildName').textContent = basic.character_guild_name || 'æ— å…¬ä¼š';
            
            // ç¶“é©—é€²åº¦æ¢
            const expRate = parseFloat(basic.character_exp_rate) || 0;
            document.getElementById('expPercent').textContent = expRate.toFixed(3) + '%';
            document.getElementById('expBarFill').style.width = expRate + '%';
            
            // é‡ç½®é è¨­é¸æ“‡å’Œç¼“å­˜
            currentPreset = 1;
            cachedEquipmentData = null;
            document.querySelectorAll('.preset-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx === 0);
            });

            // å±æ€§
            if (stat && stat.final_stat) {
                const stats = stat.final_stat;

                // ç•¶å‰æˆ°é¬¥åŠ›
                const cp = getStatValue(stats, 'æˆ°é¬¥åŠ›');
                const currentCP = parseInt(cp) || 0;
                document.getElementById('combatPower').textContent = formatNumber(currentCP);
                
                // ç•°æ­¥ç²å–5å¤©æ­·å²æœ€é«˜æˆ˜åŠ›
                loadHistoryCombatPower(currentOcid, currentCP);

                // æˆ˜æ–—å±æ€§
                const minAtk = getStatValue(stats, 'æœ€ä½å±¬æ€§æ”»æ“ŠåŠ›');
                const maxAtk = getStatValue(stats, 'æœ€é«˜å±¬æ€§æ”»æ“ŠåŠ›');
                document.getElementById('statAttack').textContent = formatNumber(parseInt(minAtk)) + ' ~ ' + formatNumber(parseInt(maxAtk));
                document.getElementById('statAtt').textContent = formatNumber(parseInt(getStatValue(stats, 'æ”»æ“ŠåŠ›')));
                document.getElementById('statStar').textContent = getStatValue(stats, 'æ˜ŸåŠ›');
                document.getElementById('statArcane').textContent = getStatValue(stats, 'ç¥ç§˜åŠ›é‡');
                document.getElementById('statAuthentic').textContent = getStatValue(stats, 'çœŸå¯¦ä¹‹åŠ›');

                // ä¼¤å®³å±æ€§
                document.getElementById('statDmg').textContent = getStatValue(stats, 'å‚·å®³') + '%';
                document.getElementById('statBoss').textContent = getStatValue(stats, 'BOSSæ€ªç‰©å‚·å®³') + '%';
                document.getElementById('statFinal').textContent = getStatValue(stats, 'æœ€çµ‚å‚·å®³') + '%';
                document.getElementById('statIED').textContent = getStatValue(stats, 'ç„¡è¦–é˜²ç¦¦ç‡') + '%';
                document.getElementById('statCrit').textContent = getStatValue(stats, 'çˆ†æ“Šæ©Ÿç‡') + '% / ' + getStatValue(stats, 'çˆ†æ“Šå‚·å®³') + '%';

                // åŸºæœ¬å±æ€§
                document.getElementById('statSTR').textContent = formatNumber(parseInt(getStatValue(stats, 'STR')));
                document.getElementById('statDEX').textContent = formatNumber(parseInt(getStatValue(stats, 'DEX')));
                document.getElementById('statINT').textContent = formatNumber(parseInt(getStatValue(stats, 'INT')));
                document.getElementById('statLUK').textContent = formatNumber(parseInt(getStatValue(stats, 'LUK')));
                document.getElementById('statHPMP').textContent = formatNumber(parseInt(getStatValue(stats, 'HP'))) + ' / ' + formatNumber(parseInt(getStatValue(stats, 'MP')));

                // é¢å¤–å±æ€§
                document.getElementById('statDrop').textContent = '+' + getStatValue(stats, 'é“å…·æ‰è½ç‡') + '%';
                document.getElementById('statMeso').textContent = '+' + getStatValue(stats, 'æ¥“å¹£ç²å¾—é‡') + '%';
                document.getElementById('statExp').textContent = '+' + getStatValue(stats, 'ç²å¾—é¡å¤–ç¶“é©—å€¼') + '%';
                document.getElementById('statBuff').textContent = '+' + getStatValue(stats, 'BuffæŒçºŒæ™‚é–“') + '%';
                document.getElementById('statCD').textContent = getStatValue(stats, 'å†·å»æ™‚é–“æ¸›å°‘(ç§’)') + 's / ' + getStatValue(stats, 'å†·å»æ™‚é–“æ¸›å°‘(ï¼…)') + '%';
            }

            showElement('result', true);
        }

        // å›è½¦æœå°‹
        document.getElementById('characterName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCharacter(e);
            }
        });

        // å­˜å‚¨è£å‚™è³‡æ–™ç”¨äºé è¨­åˆ‡æ¢
        let cachedEquipmentData = null;
        
        // å­˜å‚¨å†…åœ¨èƒ½åŠ›è³‡æ–™
        let cachedAbilityData = null;
        let currentAbilityPreset = 1;
        
        // è¼‰å…¥å†…åœ¨èƒ½åŠ›ï¼ˆå»¶è¿Ÿè¼‰å…¥é¿å…APIé™æµï¼‰
        async function loadAbility(ocid) {
            const listEl = document.getElementById('abilityList');
            if (!listEl) {
                console.error('abilityList element not found');
                return;
            }
            listEl.innerHTML = '<div class="ability-loading">è¼‰å…¥ä¸­...</div>';
            
            // é‡ç½®é è¨­æŒ‰é’®çŠ¶æ€
            currentAbilityPreset = 1;
            document.querySelectorAll('.ability-preset-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx === 0);
            });
            
            // å»¶è¿Ÿ1500msé¿å…APIé™æµ
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            try {
                const result = await apiRequest('/character/ability', { ocid });
                console.log('ğŸŒŸ Ability API response:', result);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
                if (result.error) {
                    console.error('Ability API error:', result.error);
                    // å¦‚æœæ˜¯é™æµéŒ¯èª¤ï¼Œæç¤ºç”¨æˆ·ç¨åé‡è¯•
                    if (result.error.name === 'OPENAPI00007') {
                        listEl.innerHTML = '<div class="ability-empty">â³ è«‹æ±‚éå¿«ï¼Œè«‹ç¨å¾Œé‡æ–°æ•´ç†é é¢</div>';
                    } else {
                        listEl.innerHTML = '<div class="ability-empty">APIéŒ¯èª¤: ' + (result.error.message || 'æœªçŸ¥éŒ¯èª¤') + '</div>';
                    }
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è³‡æ–™
                const hasData = result.ability_info || result.ability_preset_1;
                
                if (!hasData) {
                    listEl.innerHTML = '<div class="ability-empty">æ— å†…åœ¨èƒ½åŠ›è³‡æ–™</div>';
                    return;
                }
                
                cachedAbilityData = result;
                displayAbility(result, 1);
                
            } catch (e) {
                console.error('Load ability error:', e);
                listEl.innerHTML = '<div class="ability-empty">è¼‰å…¥å¤±è´¥: ' + e.message + '</div>';
            }
        }
        
        // åˆ‡æ¢å†…åœ¨èƒ½åŠ›é è¨­
        function changeAbilityPreset(presetNo) {
            if (!cachedAbilityData || presetNo === currentAbilityPreset) return;
            
            currentAbilityPreset = presetNo;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.ability-preset-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx + 1 === presetNo);
            });
            
            displayAbility(cachedAbilityData, presetNo);
        }
        
        // é¡¯ç¤ºå†…åœ¨èƒ½åŠ›
        function displayAbility(data, presetNo) {
            const listEl = document.getElementById('abilityList');
            
            // ç²å–å¯¹åº”é è¨­çš„èƒ½åŠ›
            let abilities = [];
            let presetGrade = '';
            
            if (presetNo === 1) {
                // ä¼˜å…ˆä½¿ç”¨ ability_preset_1ï¼Œå¦åˆ™ä½¿ç”¨é¡¶å±‚ ability_info
                if (data.ability_preset_1 && data.ability_preset_1.ability_info) {
                    abilities = data.ability_preset_1.ability_info;
                    presetGrade = data.ability_preset_1.ability_preset_grade;
                } else if (data.ability_info) {
                    abilities = data.ability_info;
                    presetGrade = data.ability_grade;
                }
            } else if (presetNo === 2 && data.ability_preset_2) {
                abilities = data.ability_preset_2.ability_info || [];
                presetGrade = data.ability_preset_2.ability_preset_grade;
            } else if (presetNo === 3 && data.ability_preset_3) {
                abilities = data.ability_preset_3.ability_info || [];
                presetGrade = data.ability_preset_3.ability_preset_grade;
            }
            
            if (!abilities || abilities.length === 0) {
                listEl.innerHTML = '<div class="ability-empty">æ­¤é è¨­æ— å†…åœ¨èƒ½åŠ›è³‡æ–™</div>';
                return;
            }
            
            // ç­‰çº§æ˜ å°„ - æ”¯æŒç¹ä½“ä¸­æ–‡å’Œè‹±æ–‡
            const gradeMap = {
                // ç¹ä½“ä¸­æ–‡
                'å‚³èªª': { class: 'legendary', name: 'å‚³èªª' },
                'ç‰¹æ®Š': { class: 'unique', name: 'ç‰¹æ®Š' },
                'ç½•è¦‹': { class: 'epic', name: 'ç½•è¦‹' },
                'ç¨€æœ‰': { class: 'rare', name: 'ç¨€æœ‰' },
                // è‹±æ–‡
                'LEGENDARY': { class: 'legendary', name: 'å‚³èªª' },
                'UNIQUE': { class: 'unique', name: 'ç‰¹æ®Š' },
                'EPIC': { class: 'epic', name: 'ç½•è¦‹' },
                'RARE': { class: 'rare', name: 'ç¨€æœ‰' }
            };
            
            let html = '';
            abilities.forEach(ability => {
                const gradeKey = ability.ability_grade || '';
                const grade = gradeMap[gradeKey] || { class: '', name: gradeKey };
                html += `
                    <div class="ability-item ${grade.class}">
                        <span class="ability-grade ${grade.class}">${grade.name}</span>
                        <span class="ability-value">${ability.ability_value || ''}</span>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }

        // ç²å–5å¤©æ­·å²æœ€é«˜æˆ˜åŠ›
        async function loadHistoryCombatPower(ocid, currentCP) {
            const maxCPElement = document.getElementById('maxCombatPower');
            const maxDateElement = document.getElementById('maxCombatPowerDate');
            
            // å…ˆé¡¯ç¤ºç•¶å‰æˆ˜åŠ›ä½œä¸ºåˆå§‹å€¼
            maxCPElement.textContent = formatNumber(currentCP);
            maxDateElement.textContent = 'ä»Šæ—¥';
            
            try {
                const today = new Date();
                const dates = [];
                
                // ç”Ÿæˆè¿‡å»5å¤©çš„æ—¥æœŸ (API è³‡æ–™æœ‰å»¶è¿Ÿï¼Œä»æ˜¨å¤©å¼€å§‹)
                for (let i = 1; i <= 5; i++) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    dates.push(d.toISOString().split('T')[0]); // YYYY-MM-DD æ ¼å¼
                }
                
                let maxCP = currentCP;
                let maxDate = 'ä»Šæ—¥';
                
                // ä¸¦è¡Œè«‹æ±‚5å¤©çš„è³‡æ–™
                const requests = dates.map(date => 
                    apiRequest('/character/stat', { ocid, date }).catch(() => null)
                );
                
                const results = await Promise.all(requests);
                
                results.forEach((result, idx) => {
                    if (result && result.final_stat) {
                        const cp = parseInt(getStatValue(result.final_stat, 'æˆ°é¬¥åŠ›')) || 0;
                        if (cp > maxCP) {
                            maxCP = cp;
                            maxDate = dates[idx];
                        }
                    }
                });
                
                // æ›´æ–°é¡¯ç¤º
                maxCPElement.textContent = formatNumber(maxCP);
                
                if (maxDate === 'ä»Šæ—¥') {
                    maxDateElement.textContent = 'ä»Šæ—¥';
                } else {
                    // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
                    const d = new Date(maxDate);
                    maxDateElement.textContent = `${d.getMonth() + 1}/${d.getDate()}`;
                }
                
                // å¦‚æœæ­·å²æœ€é«˜æ¯”ç•¶å‰é«˜ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                if (maxCP > currentCP) {
                    maxCPElement.style.color = '#ff6b6b';
                    maxCPElement.title = `æ¯”ç•¶å‰é«˜ ${formatNumber(maxCP - currentCP)}`;
                } else {
                    maxCPElement.style.color = '#43e97b';
                }
                
            } catch (e) {
                console.error('ç²å–æ­·å²æˆ˜åŠ›å¤±è´¥:', e);
                maxCPElement.textContent = formatNumber(currentCP);
                maxDateElement.textContent = 'ä»Šæ—¥';
            }
        }
        
        // åˆ‡æ¢é è¨­
        async function changePreset(presetNo) {
            console.log('ğŸ”„ changePreset called:', presetNo, '| currentPreset:', currentPreset, '| currentOcid:', currentOcid);
            
            if (!currentOcid) {
                console.log('âŒ No ocid, returning');
                return;
            }
            
            if (presetNo === currentPreset) {
                console.log('âŒ Same preset, returning');
                return;
            }
            
            currentPreset = presetNo;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.preset-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx + 1 === presetNo);
            });
            
            console.log('ğŸ“¦ cachedEquipmentData:', cachedEquipmentData ? 'exists' : 'null');
            
            // å¦‚æœæ²’æœ‰ç¼“å­˜è³‡æ–™ï¼Œå…ˆè¼‰å…¥
            if (!cachedEquipmentData) {
                console.log('â³ Loading equipment data...');
                try {
                    cachedEquipmentData = await apiRequest('/character/item-equipment', { ocid: currentOcid });
                    console.log('âœ… Equipment loaded:', cachedEquipmentData);
                } catch (e) {
                    console.error('âŒ Failed to load equipment:', e);
                    return;
                }
            }
            
            // åˆ‡æ¢é¡¯ç¤º
            displayEquipmentByPreset(cachedEquipmentData, presetNo);
            console.log('âœ… Preset switched to:', presetNo);
        }



        // é¸é …å¡åˆ‡æ¢
        function switchTab(tabName) {
            console.log('ğŸ”˜ Tab:', tabName, '| currentOcid:', currentOcid);
            
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // æ¿€æ´»å¯¹åº”æŒ‰é’®
            const buttons = document.querySelectorAll('.tab-btn');
            if (tabName === 'stats') buttons[0].classList.add('active');
            else if (tabName === 'equip') buttons[1].classList.add('active');
            else if (tabName === 'symbol') buttons[2].classList.add('active');
            else if (tabName === 'skill') buttons[3].classList.add('active');
            else if (tabName === 'union') buttons[4].classList.add('active');
            
            // åˆ‡æ¢å†…å®¹
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // æ‡’è¼‰å…¥è³‡æ–™
            if (tabName === 'equip' && currentOcid) {
                console.log('âš”ï¸ Loading equipment...');
                loadEquipment(currentOcid);
            }
            if (tabName === 'symbol' && currentOcid) {
                console.log('ğŸ”® Loading symbol...');
                loadSymbol(currentOcid);
            }
            if (tabName === 'skill' && currentOcid) {
                console.log('âœ¨ Loading skill...');
                loadSkill(currentOcid);
            }
            if (tabName === 'union' && currentOcid) {
                console.log('ğŸ° Loading union...');
                loadUnion(currentOcid);
            }
        }
        
        // è¯ç›Ÿè³‡æ–™ç¼“å­˜
        let cachedUnionData = null;
        
        // è¼‰å…¥è¯ç›Ÿè³‡æ–™
        async function loadUnion(ocid) {
            // æ£€æŸ¥æ˜¯å¦å·²è¼‰å…¥
            const levelInfo = document.getElementById('unionLevelInfo');
            if (levelInfo.dataset && levelInfo.dataset.loaded === 'true') return;
            
            levelInfo.innerHTML = '<div class="union-loading">è¼‰å…¥ä¸­...</div>';
            document.getElementById('unionArtifactInfo').innerHTML = '<div class="union-loading">è¼‰å…¥ä¸­...</div>';
            document.getElementById('unionChampionInfo').innerHTML = '<div class="union-loading">è¼‰å…¥ä¸­...</div>';
            document.getElementById('unionRaiderInfo').innerHTML = '<div class="union-loading">è¼‰å…¥ä¸­...</div>';
            
            try {
                // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰è¯ç›Ÿè³‡æ–™
                const [unionBasic, unionRaider, unionArtifact, unionChampion] = await Promise.all([
                    apiRequest('/user/union', { ocid }),
                    apiRequest('/user/union-raider', { ocid }),
                    apiRequest('/user/union-artifact', { ocid }),
                    apiRequest('/user/union-champion', { ocid })
                ]);
                
                console.log('ğŸ° Union Basic:', unionBasic);
                console.log('âš”ï¸ Union Raider:', unionRaider);
                console.log('ğŸ”± Union Artifact:', unionArtifact);
                console.log('ğŸ‘‘ Union Champion:', unionChampion);
                
                // é¡¯ç¤ºè¯ç›Ÿç­‰çº§
                displayUnionLevel(unionBasic);
                
                // é¡¯ç¤ºè¯ç›Ÿç¥å™¨
                displayUnionArtifact(unionArtifact);
                
                // é¡¯ç¤ºå† å†›è¯ç›Ÿ
                displayUnionChampion(unionChampion);
                
                // é¡¯ç¤ºè¯ç›Ÿæ”»å‡»é˜Ÿ
                displayUnionRaider(unionRaider);
                
                levelInfo.dataset.loaded = 'true';
                
            } catch (e) {
                console.error('Load union error:', e);
                levelInfo.innerHTML = '<div class="union-loading">è¼‰å…¥å¤±è´¥</div>';
            }
        }
        
        // é¡¯ç¤ºè¯ç›Ÿç­‰çº§
        function displayUnionLevel(data) {
            const container = document.getElementById('unionLevelInfo');
            
            if (data.error || !data.union_level) {
                container.innerHTML = '<div class="union-loading">æ— è¯ç›Ÿè³‡æ–™</div>';
                return;
            }
            
            container.innerHTML = `
                <div class="union-level-box">
                    <div class="union-level-number">Lv. ${data.union_level || 0}</div>
                    <div class="union-grade">${data.union_grade || ''}</div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div class="stat-row">
                        <span class="stat-name">ç¥å™¨ç­‰çº§</span>
                        <span class="stat-value">Lv. ${data.union_artifact_level || 0}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">ç¥å™¨ç¶“é©—</span>
                        <span class="stat-value">${formatNumber(data.union_artifact_exp || 0)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">ç¥å™¨ç‚¹æ•°</span>
                        <span class="stat-value">${formatNumber(data.union_artifact_point || 0)}</span>
                    </div>
                </div>
            `;
        }
        
        // é¡¯ç¤ºè¯ç›Ÿç¥å™¨
        function displayUnionArtifact(data) {
            const container = document.getElementById('unionArtifactInfo');
            
            if (data.error || !data.union_artifact_effect) {
                container.innerHTML = '<div class="union-loading">æ— ç¥å™¨è³‡æ–™</div>';
                return;
            }
            
            let html = '<div class="union-artifact-effects">';
            
            data.union_artifact_effect.forEach(effect => {
                html += `
                    <div class="artifact-effect-item">
                        <span class="artifact-effect-name">${effect.name || ''}</span>
                        <span class="artifact-effect-level">Lv.${effect.level || 0}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (data.union_artifact_remain_ap !== undefined) {
                html += `<div style="margin-top: 10px; text-align: right; color: #888;">å‰©ä½™ç‚¹æ•°: ${data.union_artifact_remain_ap}</div>`;
            }
            
            container.innerHTML = html;
        }
        
        // é¡¯ç¤ºå† å†›è¯ç›Ÿ
        function displayUnionChampion(data) {
            const container = document.getElementById('unionChampionInfo');
            
            if (data.error || !data.union_champion || data.union_champion.length === 0) {
                container.innerHTML = '<div class="union-loading">æ— å† å†›è¯ç›Ÿè³‡æ–™</div>';
                return;
            }
            
            let html = '<div class="champion-grid">';
            
            data.union_champion.forEach((champion, idx) => {
                const gradeClass = champion.champion_grade || '';
                html += `
                    <div class="champion-card">
                        <div class="champion-header">
                            <div class="champion-avatar-wrapper">
                                <img class="champion-avatar" id="champion-avatar-${idx}" src="" alt="" style="display:none;">
                                <div class="champion-avatar-placeholder" id="champion-placeholder-${idx}">ğŸ‘¤</div>
                            </div>
                            <div class="champion-info">
                                <span class="champion-name">${champion.champion_name || 'æœªçŸ¥'}</span>
                                <span class="champion-class">${champion.champion_class || ''}</span>
                            </div>
                            <span class="champion-grade ${gradeClass}">${gradeClass}</span>
                        </div>
                        <div class="champion-badges">
                `;
                
                if (champion.champion_badge_info) {
                    champion.champion_badge_info.forEach(badge => {
                        html += `<div class="champion-badge">${badge.stat || ''}</div>`;
                    });
                }
                
                html += '</div></div>';
            });
            
            html += '</div>';
            
            // æ€»æ•ˆæœ
            if (data.champion_badge_total_info && data.champion_badge_total_info.length > 0) {
                html += `
                    <div class="champion-total">
                        <h4>ğŸ“Š æ€»æ•ˆæœ</h4>
                        <div class="champion-badges">
                `;
                data.champion_badge_total_info.forEach(badge => {
                    html += `<div class="champion-badge">${badge.stat || ''}</div>`;
                });
                html += '</div></div>';
            }
            
            container.innerHTML = html;
            
            // ç•°æ­¥è¼‰å…¥å† å†›è§’è‰²é ­åƒ
            loadChampionAvatars(data.union_champion);
        }
        
        // è¼‰å…¥å† å†›è§’è‰²é ­åƒ
        async function loadChampionAvatars(champions) {
            for (let idx = 0; idx < champions.length; idx++) {
                const champion = champions[idx];
                if (!champion.champion_name) continue;
                
                try {
                    // ç²å–è§’è‰²OCID
                    const idResult = await apiRequest('/id', { character_name: champion.champion_name });
                    if (!idResult.ocid) continue;
                    
                    // ç²å–è§’è‰²åŸºæœ¬è³‡è¨Šï¼ˆå«é ­åƒï¼‰
                    const basicResult = await apiRequest('/character/basic', { ocid: idResult.ocid });
                    if (basicResult.character_image) {
                        const avatarEl = document.getElementById(`champion-avatar-${idx}`);
                        const placeholderEl = document.getElementById(`champion-placeholder-${idx}`);
                        if (avatarEl) {
                            avatarEl.src = basicResult.character_image;
                            avatarEl.style.display = 'block';
                        }
                        if (placeholderEl) {
                            placeholderEl.style.display = 'none';
                        }
                    }
                } catch (e) {
                    console.log('Failed to load champion avatar:', champion.champion_name, e);
                }
            }
        }
        
        // é¡¯ç¤ºè¯ç›Ÿæ”»å‡»é˜Ÿ
        function displayUnionRaider(data) {
            const container = document.getElementById('unionRaiderInfo');
            
            if (data.error || (!data.union_raider_stat && !data.union_occupied_stat)) {
                container.innerHTML = '<div class="union-loading">æ— æ”»å‡»é˜Ÿè³‡æ–™</div>';
                return;
            }
            
            let html = '';
            
            // æ”»å‡»é˜Ÿæ•ˆæœ
            if (data.union_raider_stat && data.union_raider_stat.length > 0) {
                html += '<div class="union-raider-stats">';
                data.union_raider_stat.forEach(stat => {
                    html += `<div class="raider-stat-item">${stat}</div>`;
                });
                html += '</div>';
            }
            
            // å é¢†æ•ˆæœ
            if (data.union_occupied_stat && data.union_occupied_stat.length > 0) {
                html += `
                    <div class="union-occupied-stats">
                        <h4>ğŸ—ºï¸ å é¢†å€åŸŸæ•ˆæœ</h4>
                        <div class="union-raider-stats">
                `;
                data.union_occupied_stat.forEach(stat => {
                    html += `<div class="raider-stat-item">${stat}</div>`;
                });
                html += '</div></div>';
            }
            
            container.innerHTML = html || '<div class="union-loading">æ— æ”»å‡»é˜Ÿè³‡æ–™</div>';
            
            // é¡¯ç¤ºè¯ç›Ÿæ‹¼å›¾
            displayUnionPuzzle(data);
        }
        
        // é¡¯ç¤ºè¯ç›Ÿæ‹¼å›¾
        function displayUnionPuzzle(data) {
            const container = document.getElementById('unionPuzzleContainer');
            
            if (!data.union_block || data.union_block.length === 0) {
                container.innerHTML = '<div class="union-loading">æ— æ‹¼å›¾è³‡æ–™</div>';
                return;
            }
            
            // å‰µå»º22x20çš„ç¶²æ ¼ (x: -11åˆ°10, y: -9åˆ°10)
            const minX = -11, maxX = 10, minY = -9, maxY = 10;
            const width = maxX - minX + 1;
            const height = maxY - minY + 1;
            
            // åˆå§‹åŒ–ç¶²æ ¼
            const grid = {};
            
            // è·æ¥­é¡å‹æ˜ å°„
            const typeMap = {
                'æˆ°å£«': 'warrior', 'åŠå£«': 'warrior',
                'æ³•å¸«': 'mage',
                'å¼“ç®­æ‰‹': 'archer',
                'ç›œè³Š': 'thief',
                'æµ·ç›œ': 'pirate',
                'hybrid': 'hybrid'
            };
            
            // å¡«å……å é¢†å€åŸŸ
            data.union_block.forEach(block => {
                const blockType = typeMap[block.block_type] || 'hybrid';
                if (block.block_position) {
                    block.block_position.forEach(pos => {
                        const key = `${pos.x},${pos.y}`;
                        grid[key] = {
                            type: blockType,
                            class: block.block_class,
                            level: block.block_level
                        };
                    });
                }
            });
            
            // ç”ŸæˆHTML
            let html = '<div class="union-puzzle">';
            
            for (let y = maxY; y >= minY; y--) {
                for (let x = minX; x <= maxX; x++) {
                    const key = `${x},${y}`;
                    const cell = grid[key];
                    const isCenter = (x >= -1 && x <= 1 && y >= -1 && y <= 1);
                    
                    if (cell) {
                        html += `<div class="puzzle-cell occupied ${cell.type}" title="${cell.class || ''} Lv.${cell.level || ''}"></div>`;
                    } else if (isCenter) {
                        html += `<div class="puzzle-cell center-zone"></div>`;
                    } else {
                        html += `<div class="puzzle-cell"></div>`;
                    }
                }
            }
            
            html += '</div>';
            
            // å›¾ä¾‹
            html += `
                <div class="puzzle-legend">
                    <div class="legend-item"><div class="legend-color" style="background:rgba(220,53,69,0.8)"></div>æˆ°å£«</div>
                    <div class="legend-item"><div class="legend-color" style="background:rgba(0,123,255,0.8)"></div>æ³•å¸«</div>
                    <div class="legend-item"><div class="legend-color" style="background:rgba(40,167,69,0.8)"></div>å¼“ç®­æ‰‹</div>
                    <div class="legend-item"><div class="legend-color" style="background:rgba(111,66,193,0.8)"></div>ç›œè³Š</div>
                    <div class="legend-item"><div class="legend-color" style="background:rgba(253,126,20,0.8)"></div>æµ·ç›œ</div>
                    <div class="legend-item"><div class="legend-color" style="background:rgba(255,193,7,0.8)"></div>å‚‘è«¾/å…¶ä»–</div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // è¼‰å…¥è£å‚™
        async function loadEquipment(ocid) {
            if (document.getElementById('equipGrid').dataset.loaded === 'true') return;
            try {
                // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰è£å‚™ç›¸é—œAPI
                const [equipResult, androidResult, petResult, cashResult, setEffectResult] = await Promise.all([
                    apiRequest('/character/item-equipment', { ocid }),
                    apiRequest('/character/android-equipment', { ocid }).catch(() => null),
                    apiRequest('/character/pet-equipment', { ocid }).catch(() => null),
                    apiRequest('/character/cashitem-equipment', { ocid }).catch(() => null),
                    apiRequest('/character/set-effect', { ocid }).catch(() => null)
                ]);
                
                cachedEquipmentData = equipResult;
                cachedEquipmentData.android_info = androidResult;
                cachedEquipmentData.pet_info = petResult;
                cachedEquipmentData.cash_info = cashResult;
                cachedEquipmentData.set_effect_info = setEffectResult;
                
                console.log('ğŸ“¦ All equipment data:', cachedEquipmentData);
                
                displayEquipmentByPreset(cachedEquipmentData, currentPreset);
                document.getElementById('equipGrid').dataset.loaded = 'true';
            } catch (e) {
                console.error('Load equipment error:', e);
                document.getElementById('equipGrid').innerHTML = '<div class="no-equip">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // æ ¹æ®é è¨­é¡¯ç¤ºè£å‚™
        function displayEquipmentByPreset(data, presetNo) {
            console.log('ğŸ“‹ displayEquipmentByPreset called, presetNo:', presetNo);
            console.log('ğŸ“‹ Available keys:', Object.keys(data));
            console.log('ğŸ“‹ Full equipment data:', JSON.stringify(data, null, 2));
            
            // æ‰“å°æ‰€æœ‰å¯èƒ½çš„ç‰¹æ®Šè£å‚™å­—æ®µ
            console.log('ğŸ‰ dragon_equipment:', data.dragon_equipment);
            console.log('âš™ï¸ mechanic_equipment:', data.mechanic_equipment);
            console.log('ğŸ·ï¸ title:', data.title);
            console.log('ğŸ’ item_equipment (æª¢æŸ¥å¯¶ç‰):', data.item_equipment?.filter(i => i.item_equipment_slot?.includes('å¯¶ç‰') || i.item_equipment_part?.includes('å¯¶ç‰')));
            console.log('ğŸ”® æ‰€æœ‰è£å‚™éƒ¨ä½:', data.item_equipment?.map(i => i.item_equipment_part || i.item_equipment_slot));
            
            const grid = document.getElementById('equipGrid');
            
            // é¸æ“‡å¯¹åº”é è¨­çš„è£å‚™è³‡æ–™
            let equipment;
            let presetEquipment;
            
            if (presetNo === 1) {
                presetEquipment = data.item_equipment_preset_1 || [];
            } else if (presetNo === 2) {
                presetEquipment = data.item_equipment_preset_2 || [];
            } else if (presetNo === 3) {
                presetEquipment = data.item_equipment_preset_3 || [];
            } else {
                presetEquipment = [];
            }
            
            // ç²å–é è¨­ä¸­å·²æœ‰çš„è£å‚™éƒ¨ä½
            const presetParts = new Set(presetEquipment.map(i => i.item_equipment_part));
            
            // å¾ item_equipment ä¸­ç²å–é è¨­ä¸­æ²’æœ‰çš„è£å‚™ï¼ˆå¦‚å¯¶ç‰ã€è¼ªè¿´ç¢‘çŸ³ã€åœ–é¨°ç­‰ï¼‰
            const additionalEquipment = (data.item_equipment || []).filter(item => {
                // é€™äº›éƒ¨ä½å¯èƒ½ä¸åœ¨é è¨­ä¸­ï¼Œéœ€è¦é¡å¤–æ·»åŠ 
                const specialParts = ['é¦¬é', 'æ€ªç‰©è£å‚™', 'é¦´æœçš„æ€ªç‰©'];
                const part = item.item_equipment_part || '';
                
                // å¦‚æœæ˜¯ç‰¹æ®Šéƒ¨ä½ä¸”é è¨­ä¸­æ²’æœ‰é€™å€‹éƒ¨ä½ï¼Œå‰‡æ·»åŠ 
                if (specialParts.some(sp => part.includes(sp))) {
                    return !presetParts.has(part);
                }
                
                // å¦‚æœæ˜¯å¢œé£¾ï¼Œæª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰3å€‹å¢œé£¾
                if (part === 'å¢œé£¾') {
                    const pendantCount = presetEquipment.filter(e => e.item_equipment_part === 'å¢œé£¾').length;
                    if (pendantCount < 3) {
                        // æª¢æŸ¥é€™å€‹å¢œé£¾æ˜¯å¦å·²åœ¨é è¨­ä¸­ï¼ˆé€šéåç¨±åˆ¤æ–·ï¼‰
                        const existingNames = presetEquipment.filter(e => e.item_equipment_part === 'å¢œé£¾').map(e => e.item_name);
                        return !existingNames.includes(item.item_name);
                    }
                }
                
                return false;
            });
            
            // åˆä½µé è¨­è£å‚™å’Œé¡å¤–è£å‚™
            equipment = [...presetEquipment, ...additionalEquipment];
            
            console.log('ğŸ“‹ Preset equipment count:', presetEquipment.length);
            console.log('ğŸ“‹ Additional equipment count:', additionalEquipment.length);
            console.log('ğŸ“‹ Total equipment count:', equipment.length);
            console.log('ğŸ“‹ Additional items:', additionalEquipment.map(i => i.item_equipment_part + ': ' + i.item_name));
            
            if (!equipment || equipment.length === 0) {
                grid.innerHTML = '<div class="no-equip">è¯¥é è¨­æš«ç„¡è£å‚™è³‡æ–™</div>';
                return;
            }
            
            // æ½›èƒ½ç­‰ç´šå°æ‡‰çš„CSSé¡
            function getPotentialClass(grade) {
                const gradeMap = {
                    'å‚³èªª': 'legendary',
                    'LEGENDARY': 'legendary',
                    'ç‰¹æ®Š': 'unique',
                    'UNIQUE': 'unique',
                    'ç½•è¦‹': 'epic',
                    'EPIC': 'epic',
                    'ç¨€æœ‰': 'rare',
                    'RARE': 'rare'
                };
                return gradeMap[grade] || '';
            }
            
            // æ½›èƒ½ç­‰ç´šåç¨±
            function getPotentialName(grade) {
                const nameMap = {
                    'å‚³èªª': 'å‚³èªª',
                    'LEGENDARY': 'å‚³èªª',
                    'ç‰¹æ®Š': 'ç‰¹æ®Š',
                    'UNIQUE': 'ç‰¹æ®Š',
                    'ç½•è¦‹': 'ç½•è¦‹',
                    'EPIC': 'ç½•è¦‹',
                    'ç¨€æœ‰': 'ç¨€æœ‰',
                    'RARE': 'ç¨€æœ‰'
                };
                return nameMap[grade] || grade;
            }
            
            // æ§‹å»ºå–®æ¢æ½›èƒ½çš„HTMLï¼ˆæ¯æ¢æ ¹æ“šè‡ªå·±çš„ç­‰ç´šé¡¯ç¤ºé¡è‰²ï¼‰
            function buildPotentialLine(value, grade) {
                if (!value) return '';
                const potClass = getPotentialClass(grade);
                return `<div class="equip-pot-line ${potClass}">${value}</div>`;
            }
            
            // æ§‹å»ºå±¬æ€§è©³æƒ…HTMLï¼ˆç¸½å€¼ = åŸºç¤ + å·è»¸ + æ˜Ÿç« + æ˜ŸåŠ›ï¼‰
            function buildStatDetails(item) {
                if (!item.item_total_option && !item.item_base_option) return '';
                
                const total = item.item_total_option || {};
                const base = item.item_base_option || {};
                const scroll = item.item_etc_option || {};  // å·è»¸
                const flame = item.item_add_option || {};   // æ˜Ÿç«
                const star = item.item_starforce_option || {}; // æ˜ŸåŠ›
                
                let html = '<div class="equip-stat-details">';
                
                // é¡¯ç¤ºå„é …å±¬æ€§ï¼ˆç¸½å€¼ = åŸºç¤ + å·è»¸ + æ˜Ÿç« + æ˜ŸåŠ›ï¼‰
                const statNames = [
                    { key: 'str', name: 'STR' },
                    { key: 'dex', name: 'DEX' },
                    { key: 'int', name: 'INT' },
                    { key: 'luk', name: 'LUK' },
                    { key: 'max_hp', name: 'æœ€å¤§HP' },
                    { key: 'attack_power', name: 'æ”»æ“ŠåŠ›' },
                    { key: 'magic_power', name: 'é­”åŠ›' },
                    { key: 'boss_damage', name: 'BOSSå‚·å®³' },
                    { key: 'ignore_monster_armor', name: 'ç„¡è¦–é˜²ç¦¦' },
                    { key: 'all_stat', name: 'å…¨å±¬æ€§' }
                ];
                
                statNames.forEach(stat => {
                    const totalVal = parseInt(total[stat.key]) || 0;
                    const baseVal = parseInt(base[stat.key]) || 0;
                    const scrollVal = parseInt(scroll[stat.key]) || 0;
                    const flameVal = parseInt(flame[stat.key]) || 0;
                    const starVal = parseInt(star[stat.key]) || 0;
                    
                    if (totalVal > 0) {
                        let detail = `${stat.name} : +${totalVal}`;
                        const parts = [];
                        if (baseVal > 0) parts.push(`<span style="color:#fff">${baseVal}</span>`);
                        if (scrollVal > 0) parts.push(`<span style="color:#cc88ff">+${scrollVal}</span>`);
                        if (flameVal > 0) parts.push(`<span style="color:#66ff66">+${flameVal}</span>`);
                        if (starVal > 0) parts.push(`<span style="color:#ffdd00">+${starVal}</span>`);
                        
                        if (parts.length > 0) {
                            detail += ` <span style="color:#888;font-size:0.85em;">( ${parts.join(' ')} )</span>`;
                        }
                        html += `<div class="equip-stat-row">${detail}</div>`;
                    }
                });
                
                html += '</div>';
                return html;
            }
            
            grid.innerHTML = equipment.map(item => {
                // æ§‹å»ºæ½›èƒ½é¡¯ç¤º
                let potentialHtml = '';
                if (item.potential_option_grade) {
                    const mainClass = getPotentialClass(item.potential_option_grade);
                    potentialHtml += `<div class="equip-pot-section">`;
                    potentialHtml += `<div class="equip-pot-title ${mainClass}">æ½›èƒ½å±¬æ€§</div>`;
                    potentialHtml += buildPotentialLine(item.potential_option_1, item.potential_option_1_grade || item.potential_option_grade);
                    potentialHtml += buildPotentialLine(item.potential_option_2, item.potential_option_2_grade || item.potential_option_grade);
                    potentialHtml += buildPotentialLine(item.potential_option_3, item.potential_option_3_grade || item.potential_option_grade);
                    potentialHtml += `</div>`;
                }
                
                // æ§‹å»ºé™„åŠ æ½›èƒ½é¡¯ç¤º
                let addPotentialHtml = '';
                if (item.additional_potential_option_grade) {
                    const addMainClass = getPotentialClass(item.additional_potential_option_grade);
                    addPotentialHtml += `<div class="equip-pot-section">`;
                    addPotentialHtml += `<div class="equip-pot-title ${addMainClass}">é™„åŠ æ½›èƒ½</div>`;
                    addPotentialHtml += buildPotentialLine(item.additional_potential_option_1, item.additional_potential_option_1_grade || item.additional_potential_option_grade);
                    addPotentialHtml += buildPotentialLine(item.additional_potential_option_2, item.additional_potential_option_2_grade || item.additional_potential_option_grade);
                    addPotentialHtml += buildPotentialLine(item.additional_potential_option_3, item.additional_potential_option_3_grade || item.additional_potential_option_grade);
                    addPotentialHtml += `</div>`;
                }
                
                // æ˜ŸåŠ›é¡¯ç¤º
                const starforceHtml = item.starforce ? `<div class="equip-starforce">â­ ${item.starforce}æ˜Ÿ${item.starforce_scroll_flag === 'ì‚¬ìš©' ? ' (å·è»¸)' : ''}</div>` : '';
                
                // è£å‚™ç­‰ç´šæ˜Ÿæ˜Ÿé¡¯ç¤º
                const gradeStars = getGradeStars(item.potential_option_grade);
                const addGradeStars = getGradeStars(item.additional_potential_option_grade);
                
                return `
                <div class="equip-item-new">
                    <div class="equip-header">
                        <img class="equip-icon-large" src="${item.item_icon || ''}" alt="">
                        <div class="equip-title">
                            <div class="equip-name-new">${item.item_name || 'æœªçŸ¥'}${item.scroll_upgrade ? ` (+${item.scroll_upgrade})` : ''}</div>
                            <div class="equip-slot-new">${item.item_equipment_part || ''}</div>
                            ${starforceHtml}
                        </div>
                    </div>
                    <div class="equip-grades">
                        ${gradeStars ? `<div class="grade-row"><span class="grade-label">æ½›èƒ½</span>${gradeStars}</div>` : ''}
                        ${addGradeStars ? `<div class="grade-row"><span class="grade-label">é™„åŠ </span>${addGradeStars}</div>` : ''}
                    </div>
                    ${buildStatDetails(item)}
                    ${potentialHtml}
                    ${addPotentialHtml}
                </div>
            `}).join('');
            
            // ç”Ÿæˆç­‰ç´šæ˜Ÿæ˜Ÿ
            function getGradeStars(grade) {
                if (!grade) return '';
                const gradeMap = {
                    'å‚³èªª': { stars: 5, color: '#2ecc71', filled: 'â˜…', empty: 'â˜†' },
                    'LEGENDARY': { stars: 5, color: '#2ecc71', filled: 'â˜…', empty: 'â˜†' },
                    'ç‰¹æ®Š': { stars: 4, color: '#3498db', filled: 'â˜…', empty: 'â˜†' },
                    'UNIQUE': { stars: 4, color: '#3498db', filled: 'â˜…', empty: 'â˜†' },
                    'ç½•è¦‹': { stars: 3, color: '#f1c40f', filled: 'â˜…', empty: 'â˜†' },
                    'EPIC': { stars: 3, color: '#f1c40f', filled: 'â˜…', empty: 'â˜†' },
                    'ç¨€æœ‰': { stars: 2, color: '#9b59b6', filled: 'â˜…', empty: 'â˜†' },
                    'RARE': { stars: 2, color: '#9b59b6', filled: 'â˜…', empty: 'â˜†' }
                };
                const info = gradeMap[grade];
                if (!info) return '';
                const filled = `<span style="color:${info.color}">${info.filled.repeat(info.stars)}</span>`;
                const empty = `<span style="color:#444">${info.empty.repeat(5 - info.stars)}</span>`;
                return filled + empty;
            }
            
            // æ§‹å»ºç‰¹æ®Šè£å‚™å¡ç‰‡
            function buildSpecialEquipCard(icon, slot, name, desc = '') {
                return `
                    <div class="equip-item-new equip-special-new">
                        <div class="equip-header">
                            <img class="equip-icon-large" src="${icon || ''}" alt="" onerror="this.style.display='none'">
                            <div class="equip-title">
                                <div class="equip-name-new">${name || 'æœªçŸ¥'}</div>
                                <div class="equip-slot-new">${slot}</div>
                                ${desc ? `<div class="equip-desc">${desc}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // æ·»åŠ ç¨±è™Ÿé¡¯ç¤º
            if (data.title) {
                const title = data.title;
                grid.innerHTML += buildSpecialEquipCard(title.title_icon, 'ğŸ·ï¸ ç¨±è™Ÿ', title.title_name, title.title_description);
            }
            
            // æ·»åŠ é¾ä¹‹è£å‚™é¡¯ç¤ºï¼ˆé¾é¨å£«å°ˆç”¨ï¼‰
            if (data.dragon_equipment && data.dragon_equipment.length > 0) {
                data.dragon_equipment.forEach(item => {
                    grid.innerHTML += buildSpecialEquipCard(item.item_icon, 'ğŸ‰ é¾ä¹‹è£å‚™', item.item_name, item.item_description);
                });
            }
            
            // æ·»åŠ æ©Ÿæ¢°è£å‚™é¡¯ç¤ºï¼ˆä¹˜åå‹æ©Ÿæ¢°å°ˆç”¨ï¼‰
            if (data.mechanic_equipment && data.mechanic_equipment.length > 0) {
                data.mechanic_equipment.forEach(item => {
                    grid.innerHTML += buildSpecialEquipCard(item.item_icon, 'âš™ï¸ æ©Ÿæ¢°è£å‚™', item.item_name);
                });
            }
            
            // æ·»åŠ Androidé¡¯ç¤º
            if (data.android_info && data.android_info.android_name) {
                const android = data.android_info;
                grid.innerHTML += buildSpecialEquipCard(android.android_icon, 'ğŸ¤– Android', android.android_name, android.android_description);
            }
            
            // æ·»åŠ å¯µç‰©é¡¯ç¤º
            if (data.pet_info) {
                const petFields = [
                    { name: data.pet_info.pet_1_name, icon: data.pet_info.pet_1_icon },
                    { name: data.pet_info.pet_2_name, icon: data.pet_info.pet_2_icon },
                    { name: data.pet_info.pet_3_name, icon: data.pet_info.pet_3_icon }
                ];
                petFields.forEach((pet, idx) => {
                    if (pet.name) {
                        grid.innerHTML += buildSpecialEquipCard(pet.icon, `ğŸ¾ å¯µç‰© ${idx + 1}`, pet.name);
                    }
                });
            }
        }

        // è¼‰å…¥ç¬¦æ–‡
        async function loadSymbol(ocid) {
            if (document.getElementById('symbolGrid').dataset.loaded === 'true') return;
            try {
                const result = await apiRequest('/character/symbol-equipment', { ocid });
                displaySymbol(result);
                document.getElementById('symbolGrid').dataset.loaded = 'true';
            } catch (e) {
                document.getElementById('symbolGrid').innerHTML = '<div class="no-equip">è¼‰å…¥å¤±è´¥</div>';
            }
        }

        // é¡¯ç¤ºç¬¦æ–‡
        function displaySymbol(data) {
            const grid = document.getElementById('symbolGrid');
            // API è¿”å›çš„æ˜¯ data.symbol è€Œä¸æ˜¯ data.symbol_equipment
            const symbols = data.symbol || [];
            if (symbols.length === 0) {
                grid.innerHTML = '<div class="no-equip">æš«ç„¡ç¬¦æ–‡è³‡æ–™</div>';
                return;
            }
            
            // ç²å–ç¬¦æ–‡å¢åŠ çš„å±æ€§
            function getSymbolStats(sym) {
                const stats = [];
                // å››ç»´å±æ€§
                if (sym.symbol_str && parseInt(sym.symbol_str) > 0) stats.push(`<span style="color:#ff6b6b;">STR +${sym.symbol_str}</span>`);
                if (sym.symbol_dex && parseInt(sym.symbol_dex) > 0) stats.push(`<span style="color:#56c5ff;">DEX +${sym.symbol_dex}</span>`);
                if (sym.symbol_int && parseInt(sym.symbol_int) > 0) stats.push(`<span style="color:#9b59b6;">INT +${sym.symbol_int}</span>`);
                if (sym.symbol_luk && parseInt(sym.symbol_luk) > 0) stats.push(`<span style="color:#43e97b;">LUK +${sym.symbol_luk}</span>`);
                if (sym.symbol_hp && parseInt(sym.symbol_hp) > 0) stats.push(`<span style="color:#f093fb;">HP +${sym.symbol_hp}</span>`);
                // ç‰¹æ®Šå±æ€§ï¼ˆè±ªåç¬¦æ–‡ï¼‰
                if (sym.symbol_drop_rate && sym.symbol_drop_rate !== '0%') stats.push(`<span style="color:#ffcd56;">æ‰å®ç‡ +${sym.symbol_drop_rate}</span>`);
                if (sym.symbol_meso_rate && sym.symbol_meso_rate !== '0%') stats.push(`<span style="color:#ffd700;">é‡‘å¸ +${sym.symbol_meso_rate}</span>`);
                if (sym.symbol_exp_rate && sym.symbol_exp_rate !== '0%') stats.push(`<span style="color:#00f2fe;">ç¶“é©— +${sym.symbol_exp_rate}</span>`);
                return stats.join('<br>');
            }
            
            // åˆ¤æ–­ç¬¦æ–‡é¡å‹ï¼ˆç¥ç§˜/çœŸå®/è±ªåï¼‰
            function getSymbolType(name) {
                if (name.includes('è±ªè¯')) return { type: 'è±ªåçœŸå®ç¬¦æ–‡', color: '#ffd700', forceType: 'çœŸå®ä¹‹åŠ›' };
                if (name.includes('çœŸå¯¦')) return { type: 'çœŸå®ç¬¦æ–‡', color: '#56c5ff', forceType: 'çœŸå®ä¹‹åŠ›' };
                return { type: 'ç§˜æ³•ç¬¦æ–‡', color: '#9b59b6', forceType: 'ç¥ç§˜åŠ›é‡' };
            }
            
            grid.innerHTML = symbols.map(sym => {
                const typeInfo = getSymbolType(sym.symbol_name || '');
                const statsHtml = getSymbolStats(sym);
                return `
                <div class="symbol-item" style="padding:15px;">
                    <img src="${sym.symbol_icon || ''}" alt="" style="width:45px;height:45px;margin-bottom:8px;">
                    <div class="symbol-name" style="font-size:0.85em;line-height:1.3;">${sym.symbol_name || 'æœªçŸ¥ç¬¦æ–‡'}</div>
                    <div class="symbol-level" style="color:${typeInfo.color};font-weight:bold;">Lv.${sym.symbol_level || 0}</div>
                    <div style="color:#ffcd56;font-size:0.85em;margin:5px 0;">
                        ${typeInfo.forceType} +${sym.symbol_force || 0}
                    </div>
                    <div style="font-size:0.8em;line-height:1.5;">
                        ${statsHtml || '<span style="color:#666;">æ— å±æ€§åŠ æˆ</span>'}
                    </div>
                </div>
            `}).join('');
        }

        // è¼‰å…¥æŠ€èƒ½
        async function loadSkill(ocid) {
            if (document.getElementById('skillGrid').dataset.loaded === 'true') return;
            try {
                // åŒæ—¶ç²å– VçŸ©é˜µã€HEXAæ ¸å¿ƒã€ä»¥åŠæŠ€èƒ½åœ–æ¨™ï¼ˆ5è½¬å’Œ6è½¬æŠ€èƒ½ï¼‰
                const [vmatrix, hexamatrix, skill5, skill6] = await Promise.all([
                    apiRequest('/character/vmatrix', { ocid }),
                    apiRequest('/character/hexamatrix', { ocid }),
                    apiRequest('/character/skill', { ocid, character_skill_grade: '5' }),
                    apiRequest('/character/skill', { ocid, character_skill_grade: '6' })
                ]);
                
                // å»ºç«‹æŠ€èƒ½åç§°åˆ°åœ–æ¨™çš„æ˜ å°„
                const skillIconMap = {};
                const allSkills = [...(skill5.character_skill || []), ...(skill6.character_skill || [])];
                allSkills.forEach(skill => {
                    if (skill.skill_name && skill.skill_icon) {
                        skillIconMap[skill.skill_name] = skill.skill_icon;
                        // åŒæ—¶æ·»åŠ ä¸€äº›å˜ä½“åç§°çš„æ˜ å°„
                        const baseName = skill.skill_name.replace(/VI$/i, '').replace(/V$/i, '').trim();
                        if (baseName && !skillIconMap[baseName]) {
                            skillIconMap[baseName] = skill.skill_icon;
                        }
                    }
                });
                
                displaySkill(vmatrix, hexamatrix, skillIconMap);
                document.getElementById('skillGrid').dataset.loaded = 'true';
            } catch (e) {
                document.getElementById('skillGrid').innerHTML = '<div class="no-equip">è¼‰å…¥å¤±è´¥: ' + e.message + '</div>';
            }
        }

        // é¡¯ç¤ºæŠ€èƒ½
        function displaySkill(vmatrix, hexamatrix, skillIconMap) {
            const grid = document.getElementById('skillGrid');
            let html = '';
            
            // æ ¹æ®æŠ€èƒ½åæŸ¥æ‰¾åœ–æ¨™
            function findIcon(skillName) {
                if (!skillName) return '';
                // ç›´æ¥åŒ¹é…
                if (skillIconMap[skillName]) return skillIconMap[skillName];
                // å°è¯•ç§»é™¤åç¼€
                const baseName = skillName.replace(/VI$/i, '').replace(/V$/i, '').trim();
                if (skillIconMap[baseName]) return skillIconMap[baseName];
                // å°è¯•åŒ¹é…æŠ€èƒ½åçš„ç¬¬ä¸€ä¸ªæŠ€èƒ½ï¼ˆå¦‚ "å¼·åŒ–xxx" æ˜ å°„åˆ° "xxx"ï¼‰
                const cleanName = skillName.replace(/^å¼·åŒ–/, '').trim();
                if (skillIconMap[cleanName]) return skillIconMap[cleanName];
                return '';
            }
            
            // HEXAæ ¸å¿ƒ (6è½¬) - ä¼˜å…ˆé¡¯ç¤º
            const hexaCores = hexamatrix && hexamatrix.character_hexa_core_equipment || [];
            if (hexaCores.length > 0) {
                html += `<div style="grid-column: 1/-1; font-weight: bold; color: #56c5ff; margin: 10px 0; font-size: 1.1em;">ğŸ”· HEXAæ ¸å¿ƒ (${hexaCores.length})</div>`;
                html += hexaCores.map(hex => {
                    // å°è¯•ä»å…³è”æŠ€èƒ½ç²å–åœ–æ¨™
                    let iconUrl = '';
                    if (hex.linked_skill && hex.linked_skill.length > 0) {
                        for (const ls of hex.linked_skill) {
                            iconUrl = findIcon(ls.hexa_skill_id);
                            if (iconUrl) break;
                        }
                    }
                    if (!iconUrl) iconUrl = findIcon(hex.hexa_core_name);
                    
                    const typeColor = hex.hexa_core_type === 'æŠ€èƒ½æ ¸å¿ƒ' ? '#ff6b6b' : 
                                     hex.hexa_core_type === 'ç²¾é€šæ ¸å¿ƒ' ? '#56c5ff' : 
                                     hex.hexa_core_type === 'å¼·åŒ–æ ¸å¿ƒ' ? '#ffcd56' : 
                                     hex.hexa_core_type === 'å…±ç”¨æ ¸å¿ƒ' ? '#9b59b6' : '#aaa';
                    
                    return `
                    <div class="skill-item" style="display: flex; align-items: center; gap: 12px; padding: 12px;">
                        ${iconUrl ? `<img src="${iconUrl}" alt="" style="width:40px;height:40px;border-radius:8px;background:#1a1a2e;">` : '<div style="width:40px;height:40px;border-radius:8px;background:#1a1a2e;display:flex;align-items:center;justify-content:center;font-size:20px;">âœ¨</div>'}
                        <div style="flex:1;min-width:0;">
                            <div class="skill-name" style="font-size:0.95em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${hex.hexa_core_name || 'æœªçŸ¥'}</div>
                            <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
                                <span class="skill-level" style="color:#56c5ff;">Lv.${hex.hexa_core_level || 0}</span>
                                <span style="color:${typeColor};font-size:0.8em;padding:2px 6px;background:rgba(255,255,255,0.1);border-radius:4px;">${hex.hexa_core_type || ''}</span>
                            </div>
                        </div>
                    </div>
                `}).join('');
            }
            
            // VçŸ©é˜µ (5è½¬)
            const vCores = vmatrix && vmatrix.character_v_core_equipment || [];
            // è¿‡æ»¤æ‰ç©ºæ ¸å¿ƒ
            const validVCores = vCores.filter(v => v.v_core_name);
            if (validVCores.length > 0) {
                html += `<div style="grid-column: 1/-1; font-weight: bold; color: #ff9a56; margin: 20px 0 10px; font-size: 1.1em;">ğŸ”¶ VçŸ©é™£ (${validVCores.length})</div>`;
                html += validVCores.map(v => {
                    // æŸ¥æ‰¾åœ–æ¨™ - ä¼˜å…ˆä½¿ç”¨æŠ€èƒ½1çš„åç§°
                    let iconUrl = findIcon(v.v_core_skill_1) || findIcon(v.v_core_name);
                    
                    const typeColor = v.v_core_type === 'æŠ€èƒ½æ ¸å¿ƒ' ? '#ff6b6b' : 
                                     v.v_core_type === 'å¼·åŒ–æ ¸å¿ƒ' ? '#ffcd56' : 
                                     v.v_core_type === 'ç‰¹æ®Šæ ¸å¿ƒ' ? '#9b59b6' : '#aaa';
                    
                    return `
                    <div class="skill-item" style="display: flex; align-items: center; gap: 12px; padding: 12px;">
                        ${iconUrl ? `<img src="${iconUrl}" alt="" style="width:40px;height:40px;border-radius:8px;background:#1a1a2e;">` : '<div style="width:40px;height:40px;border-radius:8px;background:#1a1a2e;display:flex;align-items:center;justify-content:center;font-size:20px;">âš¡</div>'}
                        <div style="flex:1;min-width:0;">
                            <div class="skill-name" style="font-size:0.95em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${v.v_core_name || 'æœªçŸ¥'}</div>
                            <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
                                <span class="skill-level" style="color:#ff9a56;">Lv.${v.v_core_level || 0}</span>
                                <span style="color:${typeColor};font-size:0.8em;padding:2px 6px;background:rgba(255,255,255,0.1);border-radius:4px;">${v.v_core_type || ''}</span>
                            </div>
                        </div>
                    </div>
                `}).join('');
            }
            
            if (!html) {
                html = '<div class="no-equip">æš«ç„¡æŠ€èƒ½è³‡æ–™</div>';
            }
            grid.innerHTML = html;
        }

        // ==================== æ’è¡Œæ¦œåŠŸèƒ½ ====================
        
        // åˆå§‹åŒ–è·æ¥­ä¸‹æ‹‰åˆ—è¡¨
        function initClassSelect() {
            const select = document.getElementById('rankingClass');
            if (!select) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²è¼‰å…¥å¤–éƒ¨è·æ¥­è³‡æ–™
            if (typeof TW_CLASS_DATA !== 'undefined') {
                populateClassSelect(TW_CLASS_DATA);
            } else {
                // å¦‚æœå¤–éƒ¨æ–‡ä»¶è¼‰å…¥å¤±è´¥ï¼Œä½¿ç”¨æ‰‹åŠ¨è¼¸å…¥
                select.innerHTML = '<option value="">å…¨éƒ¨è·æ¥­</option><option value="_manual">-- æ‰‹åŠ¨è¼¸å…¥è·æ¥­å --</option>';
                setupManualInput(select);
            }
        }
        
        // å¡«å……è·æ¥­ä¸‹æ‹‰åˆ—è¡¨
        function populateClassSelect(classGroups) {
            const select = document.getElementById('rankingClass');
            select.innerHTML = '<option value="">å…¨éƒ¨è·æ¥­</option>';
            
            classGroups.forEach(([groupName, classes]) => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = groupName;
                
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls;
                    option.textContent = cls;
                    optgroup.appendChild(option);
                });
                
                select.appendChild(optgroup);
            });
            
            // æ·»åŠ æ‰‹åŠ¨è¼¸å…¥é€‰é¡¹
            const manualOption = document.createElement('option');
            manualOption.value = '_manual';
            manualOption.textContent = '-- æ‰‹åŠ¨è¼¸å…¥å…¶ä»–è·æ¥­ --';
            select.appendChild(manualOption);
            
            setupManualInput(select);
        }
        
        // è¨­å®šæ‰‹åŠ¨è¼¸å…¥åŠŸèƒ½
        function setupManualInput(select) {
            select.addEventListener('change', function() {
                if (this.value === '_manual') {
                    const className = prompt('è«‹è¼¸å…¥è·æ¥­åç§°ï¼ˆç¹ä½“ä¸­æ–‡ï¼‰ï¼š');
                    if (className && className.trim()) {
                        const option = document.createElement('option');
                        option.value = className.trim();
                        option.textContent = className.trim();
                        this.insertBefore(option, this.querySelector('option[value="_manual"]'));
                        this.value = className.trim();
                    } else {
                        this.value = '';
                    }
                }
            });
        }
        
        // é é¢è¼‰å…¥å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initClassSelect);
        
        // åˆ‡æ¢ä¸»é é¢
        function switchMainTab(tabName) {
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach((tab, idx) => {
                tab.classList.toggle('active', (idx === 0 && tabName === 'search') || (idx === 1 && tabName === 'ranking'));
            });
            
            document.getElementById('search-section').style.display = tabName === 'search' ? 'block' : 'none';
            document.getElementById('ranking-section').classList.toggle('show', tabName === 'ranking');
        }
        
        // è¼‰å…¥æ’è¡Œæ¦œ
        async function loadRanking(page = 1) {
            const world = document.getElementById('rankingWorld').value;
            const classFilter = document.getElementById('rankingClass').value;
            const listEl = document.getElementById('rankingList');
            const paginationEl = document.getElementById('rankingPagination');
            
            // é¡¯ç¤ºè¼‰å…¥
            listEl.innerHTML = '<div class="ranking-loading"><div class="spinner"></div><p>æ­£åœ¨è¼‰å…¥æ’è¡Œæ¦œ...</p></div>';
            paginationEl.style.display = 'none';
            
            try {
                // æ§‹å»ºè«‹æ±‚åƒæ•¸
                const params = {};
                if (world) params.world_name = world;
                if (classFilter) params.character_class = classFilter;
                params.page = page;
                
                console.log('ğŸ† Ranking params:', params);
                
                // èª¿ç”¨æ’è¡Œæ¦œAPI
                const result = await apiRequest('/ranking/overall', params);
                
                console.log('ğŸ“Š Ranking result:', result);
                
                if (result.error) {
                    let errorMsg = result.error.message || 'è¼‰å…¥å¤±è´¥';
                    if (result.error.name === 'OPENAPI00003' || errorMsg.includes('Access denied')) {
                        errorMsg = 'âš ï¸ API Key æ²’æœ‰æ’è¡Œæ¦œæƒé™\n\nè«‹åˆ° Nexon Open API ç½‘ç«™ç”³è«‹ã€Œæ’è¡Œæ¦œã€API æƒé™';
                    }
                    listEl.innerHTML = `<div class="ranking-empty" style="white-space: pre-line;">âŒ ${errorMsg}</div>`;
                    return;
                }
                
                const rankings = result.ranking || [];
                
                if (rankings.length === 0) {
                    listEl.innerHTML = '<div class="ranking-empty">ğŸ“­ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è§’è‰²</div>';
                    return;
                }
                
                currentRankPage = page;
                
                // å…ˆé¡¯ç¤ºåŸºæœ¬æ’è¡Œæ¦œï¼ˆæŒ‰ç­‰çº§æ’åºçš„å®˜æ–¹è³‡æ–™ï¼‰
                displayRankingList(rankings, page, listEl);
                
                // é¡¯ç¤ºåˆ†é¡µ
                paginationEl.style.display = 'flex';
                document.getElementById('prevPageBtn').disabled = page <= 1;
                document.getElementById('pageInfo').textContent = `ç¬¬ ${page} é¡µ`;
                document.getElementById('nextPageBtn').disabled = rankings.length < 10;
                
                // ç•°æ­¥è¼‰å…¥æ¯ä¸ªè§’è‰²çš„æˆ°é¬¥åŠ›å’Œé ­åƒ
                loadRankingDetails(rankings);
                
            } catch (e) {
                console.error('Ranking error:', e);
                listEl.innerHTML = `<div class="ranking-empty">âŒ è«‹æ±‚å¤±æ•—: ${e.message}</div>`;
            }
        }
        
        // é¡¯ç¤ºæ’è¡Œæ¦œåˆ—è¡¨
        function displayRankingList(rankings, page, listEl) {
            let html = `
                <div class="ranking-header">
                    <div>æ’å</div>
                    <div>é ­åƒ</div>
                    <div>è§’è‰²</div>
                    <div>ä¼ºæœå™¨</div>
                    <div>ç­‰çº§</div>
                    <div>æˆ°é¬¥åŠ›</div>
                </div>
            `;
            
            rankings.forEach((char, idx) => {
                const rank = char.ranking || ((page - 1) * 10 + idx + 1);
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const serverInfo = serverColors[char.world_name] || { bg: 'linear-gradient(135deg, #6c757d, #495057)', letter: (char.world_name || '?').charAt(0) };
                
                html += `
                    <div class="ranking-item" id="rank-item-${idx}" onclick="searchFromRanking('${char.character_name}')">
                        <div class="rank-number ${rankClass}">#${rank}</div>
                        <div>
                            <img class="rank-avatar" id="rank-avatar-${idx}" src="${char.character_image || ''}" alt="" onerror="this.style.display='none'" style="${char.character_image ? '' : 'display:none'}">
                            <div id="rank-avatar-placeholder-${idx}" style="width:50px;height:50px;border-radius:8px;background:rgba(255,255,255,0.1);display:${char.character_image ? 'none' : 'flex'};align-items:center;justify-content:center;font-size:20px;">ğŸ‘¤</div>
                        </div>
                        <div>
                            <div class="rank-name">${char.character_name || 'æœªçŸ¥'}</div>
                            <div class="rank-class">${char.sub_class_name || char.character_class || ''}</div>
                        </div>
                        <div class="rank-server">
                            <span class="server-icon" style="background: ${serverInfo.bg}; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold;">${serverInfo.letter}</span>
                            <span>${char.world_name || ''}</span>
                        </div>
                        <div style="font-weight: bold; color: #ffcd56;">Lv.${char.character_level || 0}</div>
                        <div class="rank-power" id="rank-power-${idx}">
                            <span style="color:#888;font-size:0.9em;">è¼‰å…¥ä¸­...</span>
                        </div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }
        
        // ç•°æ­¥è¼‰å…¥è§’è‰²è©³æƒ…ï¼ˆé ­åƒå’Œæˆ°é¬¥åŠ›ï¼‰
        async function loadRankingDetails(rankings) {
            // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰è§’è‰²è³‡æ–™ï¼ˆæ¯ä¸ªè§’è‰²3ä¸ªAPIèª¿ç”¨ï¼‰
            rankings.forEach(async (char, idx) => {
                try {
                    // ç²å–ocid
                    const idResult = await apiRequest('/id', { character_name: char.character_name });
                    if (!idResult.ocid) {
                        document.getElementById(`rank-power-${idx}`).innerHTML = '<span style="color:#666;">-</span>';
                        return;
                    }
                    
                    // ä¸¦è¡Œç²å–åŸºæœ¬è³‡è¨Šå’Œå±æ€§
                    const [basicResult, statResult] = await Promise.all([
                        apiRequest('/character/basic', { ocid: idResult.ocid }),
                        apiRequest('/character/stat', { ocid: idResult.ocid })
                    ]);
                    
                    // æ›´æ–°é ­åƒ
                    if (basicResult.character_image) {
                        const avatarEl = document.getElementById(`rank-avatar-${idx}`);
                        const placeholderEl = document.getElementById(`rank-avatar-placeholder-${idx}`);
                        if (avatarEl) {
                            avatarEl.src = basicResult.character_image;
                            avatarEl.style.display = 'block';
                        }
                        if (placeholderEl) {
                            placeholderEl.style.display = 'none';
                        }
                    }
                    
                    // æ›´æ–°æˆ°é¬¥åŠ›
                    if (statResult.final_stat) {
                        const power = getStatValue(statResult.final_stat, 'æˆ°é¬¥åŠ›');
                        const powerValue = parseInt(power) || 0;
                        const powerEl = document.getElementById(`rank-power-${idx}`);
                        if (powerEl) {
                            powerEl.innerHTML = `<span style="background: linear-gradient(90deg, #ff9a56, #ffcd56); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold;">${formatNumber(powerValue)}</span>`;
                        }
                    } else {
                        document.getElementById(`rank-power-${idx}`).innerHTML = '<span style="color:#666;">-</span>';
                    }
                    
                } catch (e) {
                    console.log('Failed to load details for', char.character_name, e);
                    const powerEl = document.getElementById(`rank-power-${idx}`);
                    if (powerEl) {
                        powerEl.innerHTML = '<span style="color:#666;">-</span>';
                    }
                }
            });
        }
        
        // ä»æ’è¡Œæ¦œç‚¹å‡»è·³è½¬æœå°‹
        function searchFromRanking(characterName) {
            document.getElementById('characterName').value = characterName;
            switchMainTab('search');
            searchCharacter(new Event('submit'));
        }
    </script>
</body>
</html>
